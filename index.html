<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>iwasemi｜音問題 診断サービス（ベータ）</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root { color-scheme: light dark; }
    .fade-enter { opacity: 0; transform: translateY(6px); }
    .fade-enter-active { opacity: 1; transform: translateY(0); transition: all .24s ease; }
    .badge{ display:inline-block; padding:.125rem .5rem; border-radius:.5rem; font-size:.75rem; border:1px solid rgba(16,185,129,.35);}
  </style>
</head>
<body class="bg-slate-50 text-slate-900 selection:bg-emerald-200/60 dark:bg-slate-900 dark:text-slate-50">
  <div class="max-w-6xl mx-auto p-4 md:p-8">
    <header class="flex items-center justify-between gap-4 mb-6">
      <div class="flex items-center gap-3">
        <div class="size-10 rounded-2xl bg-emerald-500/90 flex items-center justify-center text-white font-bold">i</div>
        <div>
          <h1 class="text-xl md:text-2xl font-bold">iwasemi｜音問題 診断サービス（ベータ）</h1>
          <p class="text-sm text-slate-500 dark:text-slate-400">入力から残響・遮音の課題を解析し、最適解と概算を自動提示します。</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="themeToggle" class="px-3 py-2 rounded-xl border border-slate-300/60 dark:border-slate-700 text-sm">🌙/☀️</button>
        <a href="#result" class="px-3 py-2 rounded-xl bg-emerald-600 text-white text-sm">結果を見る</a>
      </div>
    </header>

    <div id="progress" class="w-full h-2 bg-slate-200 dark:bg-slate-800 rounded-full overflow-hidden mb-6">
      <div id="progressBar" class="h-full w-[0%] bg-emerald-500 transition-all"></div>
    </div>

    <form id="diagForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <section class="md:col-span-2 p-4 md:p-6 rounded-2xl bg-white dark:bg-slate-800 shadow-sm">
        <h2 class="text-lg font-semibold mb-4">1) 基本情報</h2>
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
          <label class="block">
            <span class="text-sm">会社名</span>
            <input name="company" required class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent" placeholder="株式会社○○" />
          </label>
          <label class="block">
            <span class="text-sm">案件名</span>
            <input name="projectName" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent" placeholder="○○プロジェクト" />
          </label>
          <label class="block">
            <span class="text-sm">お名前</span>
            <input name="person" required class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent" placeholder="山田 太郎" />
          </label>
          <label class="block">
            <span class="text-sm">代理店の部署・支店名</span>
            <input name="agentBranch" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent" placeholder="○○支店 / ○○営業部" />
          </label>
          <label class="block">
            <span class="text-sm">メール</span>
            <input name="email" type="email" required class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent" placeholder="taro@example.com" />
          </label>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mt-4">
          <label class="block">
            <span class="text-sm">業種</span>
            <select name="industry" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
              <option>IT</option><option>製造</option><option>金融</option><option>学校</option><option>医療</option>
              <option>官公庁</option><option>BPO/コール</option><option>商業</option><option>物流</option><option>その他</option>
            </select>
          </label>
          <label class="block">
            <span class="text-sm">規模</span>
            <select name="size" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
              <option>〜100名</option><option>101–500</option><option>501–1000</option><option>1001–5000</option><option>5001〜</option>
            </select>
          </label>
          <label class="block md:col-span-2">
            <span class="text-sm">都道府県</span>
            <select name="pref" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
              <option value="">選択してください</option>
              <option>北海道</option><option>青森県</option><option>岩手県</option><option>宮城県</option><option>秋田県</option><option>山形県</option><option>福島県</option>
              <option>茨城県</option><option>栃木県</option><option>群馬県</option><option>埼玉県</option><option>千葉県</option><option>東京都</option><option>神奈川県</option>
              <option>新潟県</option><option>富山県</option><option>石川県</option><option>福井県</option><option>山梨県</option><option>長野県</option>
              <option>岐阜県</option><option>静岡県</option><option>愛知県</option><option>三重県</option>
              <option>滋賀県</option><option>京都府</option><option>大阪府</option><option>兵庫県</option><option>奈良県</option><option>和歌山県</option>
              <option>鳥取県</option><option>島根県</option><option>岡山県</option><option>広島県</option><option>山口県</option>
              <option>徳島県</option><option>香川県</option><option>愛媛県</option><option>高知県</option>
              <option>福岡県</option><option>佐賀県</option><option>長崎県</option><option>熊本県</option><option>大分県</option><option>宮崎県</option><option>鹿児島県</option><option>沖縄県</option>
            </select>
          </label>
          <label class="block">
            <span class="text-sm">実施想定時期</span>
            <select name="timeline" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
              <option>今期</option><option>来期</option><option selected>未定</option>
            </select>
          </label>
        </div>
      </section>

      <section class="p-4 md:p-6 rounded-2xl bg-white dark:bg-slate-800 shadow-sm">
        <h2 class="text-lg font-semibold mb-4">2) 空間の基本情報</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <label class="block">
            <span class="text-sm">プロジェクト種別</span>
            <select name="project" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
              <option>移転</option><option>改修</option><option selected>既存</option>
            </select>
          </label>
          <label class="block">
            <span class="text-sm">空間カテゴリー</span>
            <select name="category" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
              <option value="office">オフィス</option>
              <option value="nonoffice">オフィス以外（工場/学校/図書館/商業/スタジオ等）</option>
            </select>
          </label>
          <label class="block">
            <span class="text-sm">空間タイプ</span>
            <select name="spaceType" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
              <option value="meeting_closed">会議室（密閉）</option>
              <option value="meeting_transom">会議室（欄間オープン）</option>
              <option value="booth_tel">ワークブース（TELECUBE）</option>
              <option value="booth_built">ワークブース（造作）</option>
              <option value="open">オープンスペース（執務室）</option>
              <option value="reception">受付</option>
              <option value="callcenter">コールセンター</option>
              <option value="studio">スタジオ</option>
              <option value="other">その他</option>
            </select>
          </label>
          <div>
            <span class="text-sm block mb-1">利用用途（複数選択可）</span>
            <div class="grid grid-cols-1 gap-1">
              <label class="flex items-center gap-2"><input type="checkbox" name="use" value="meeting_multi" class="size-4">会議（複数人）</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="use" value="meeting_1to1" class="size-4">会議（1対1/少人数）</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="use" value="meeting_web" class="size-4">会議（Webメイン）</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="use" value="meeting_f2f" class="size-4">会議（対面メイン）</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="use" value="meeting_hybrid" class="size-4">会議（対面＋Web）</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="use" value="exec" class="size-4">役員会議</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="use" value="internal" class="size-4">社内会議</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="use" value="external" class="size-4">社外会議</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="use" value="focus" class="size-4">集中作業</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="use" value="phone" class="size-4">電話（個人/顧客）</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="use" value="websolo" class="size-4">Web会議（1人）</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="use" value="music" class="size-4">音楽鑑賞</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="use" value="stream" class="size-4">配信・収録</label>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
          <div>
            <span class="text-sm block mb-1">騒音源（複数選択可）</span>
            <label class="flex items-center gap-2"><input type="checkbox" name="source" value="speech" class="size-4">人の声</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="source" value="machine" class="size-4">機械音</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="source" value="invasion_ext" class="size-4">外部からの音の侵入</label>
          </div>
          <label class="block">
            <span class="text-sm">従業員の声（うるささ）</span>
            <select name="complaint" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
              <option value="low">低</option><option value="mid" selected>中</option><option value="high">高</option>
            </select>
          </label>
          <div>
            <span class="text-sm block mb-1">既存対策</span>
            <label class="flex items-center gap-2"><input type="checkbox" name="measure" value="partition" class="size-4">パーティション</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="measure" value="absorption" class="size-4">吸音パネル</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="measure" value="masking" class="size-4">サウンドマスキング</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="measure" value="none" class="size-4">特になし</label>
          </div>
        </div>
      </section>

      <section class="p-4 md:p-6 rounded-2xl bg-white dark:bg-slate-800 shadow-sm">
        <h2 class="text-lg font-semibold mb-4">3) 空間サイズ・構成要素</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <label class="block">
            <span class="text-sm">床面積（㎡/室）</span>
            <input name="area" type="number" min="1" step="0.1" value="20" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent" />
          </label>
          <label class="block">
            <span class="text-sm">室数（同仕様）</span>
            <input name="rooms" type="number" min="1" value="1" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent" />
          </label>
          <label class="block">
            <span class="text-sm">天井高</span>
            <select name="ceilHeight" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
              <option value="lt2_5">2.5m未満</option>
              <option value="2_5_3_0" selected>2.5〜3.0m</option>
              <option value="3_0_3_5">3.0〜3.5m</option>
              <option value="gt3_5">3.5m以上</option>
              <option value="unknown">不明</option>
            </select>
          </label>
        </div>

        <div class="mt-4">
          <span class="text-sm block mb-2">壁材（4面）</span>
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <label class="block"><span class="text-xs text-slate-500">壁①</span>
              <select name="wall1" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
                <option value="gypsum">石膏ボード＋クロス</option><option value="glass_s">ガラス（シングル）</option><option value="glass_d">ガラス（ダブル）</option><option value="rc">コンクリート打放し</option><option value="abs_finish">吸音パネル仕上げ</option><option value="wood">木質</option><option value="unknown">不明</option>
              </select>
            </label>
            <label class="block"><span class="text-xs text-slate-500">壁②</span>
              <select name="wall2" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
                <option value="gypsum">石膏ボード＋クロス</option><option value="glass_s">ガラス（シングル）</option><option value="glass_d">ガラス（ダブル）</option><option value="rc">コンクリート打放し</option><option value="abs_finish">吸音パネル仕上げ</option><option value="wood">木質</option><option value="unknown">不明</option>
              </select>
            </label>
            <label class="block"><span class="text-xs text-slate-500">壁③</span>
              <select name="wall3" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
                <option value="gypsum">石膏ボード＋クロス</option><option value="glass_s">ガラス（シングル）</option><option value="glass_d">ガラス（ダブル）</option><option value="rc">コンクリート打放し</option><option value="abs_finish">吸音パネル仕上げ</option><option value="wood">木質</option><option value="unknown">不明</option>
              </select>
            </label>
            <label class="block"><span class="text-xs text-slate-500">壁④</span>
              <select name="wall4" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
                <option value="gypsum">石膏ボード＋クロス</option><option value="glass_s">ガラス（シングル）</option><option value="glass_d">ガラス（ダブル）</option><option value="rc">コンクリート打放し</option><option value="abs_finish">吸音パネル仕上げ</option><option value="wood">木質</option><option value="unknown">不明</option>
              </select>
            </label>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
          <label class="block">
            <span class="text-sm">床材</span>
            <select name="floor" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
              <option value="carpet">タイルカーペット</option><option value="wood">フローリング</option><option value="pvc">塩ビシート（PVC）</option><option value="tile_stone">タイル・石材</option><option value="unknown">不明</option>
            </select>
          </label>
          <label class="block">
            <span class="text-sm">天井材</span>
            <select name="ceiling" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
              <option value="pb">化粧石膏ボード</option><option value="mineral_grid">岩綿吸音板（グリッド）</option><option value="metal">金属パネル天井</option><option value="exposed">露出天井（スケルトン）</option><option value="unknown">不明</option>
            </select>
          </label>
          <label class="block">
            <span class="text-sm">扉の種類</span>
            <select name="door" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
              <option value="wood_solid">木製（単板）</option><option value="wood_honeycomb">木製（中空ハニカム）</option><option value="glass_s">ガラス（シングル）</option><option value="glass_d">ガラス（ダブル）</option><option value="steel">スチールドア</option><option value="unknown">不明</option>
            </select>
          </label>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
          <label class="block">
            <span class="text-sm">扉の隙間処理</span>
            <select name="doorSeal" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
              <option value="gasket">ゴムパッキンあり（遮音）</option>
              <option value="bottom">ドアボトムシールあり</option>
              <option value="gap">隙間あり（標準）</option>
              <option value="unknown">不明</option>
            </select>
          </label>
          <label class="block">
            <span class="text-sm">ガラスの種類</span>
            <select name="glazing" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
              <option value="single">シングルガラス</option>
              <option value="double">ダブルガラス（ペア）</option>
              <option value="unknown">不明</option>
            </select>
          </label>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-4">
          <label class="flex items-center gap-2"><input type="checkbox" name="feature" value="transom" class="size-4">欄間オープン</label>
          <label class="flex items-center gap-2"><input type="checkbox" name="feature" value="shared_plenum" class="size-4">共有天井裏（隣室と連続）</label>
          <label class="flex items-center gap-2"><input type="checkbox" name="feature" value="grille" class="size-4">ガラリ／換気開口あり</label>
          <label class="flex items-center gap-2"><input type="checkbox" name="feature" value="gap_door_bottom" class="size-4">ドア下の隙間</label>
          <label class="flex items-center gap-2"><input type="checkbox" name="feature" value="gap_frame" class="size-4">枠まわりの隙間</label>
          <label class="flex items-center gap-2"><input type="checkbox" name="feature" value="gap_penetration" class="size-4">貫通部の隙間</label>
          <label class="flex items-center gap-2"><input type="checkbox" name="feature" value="gap_duct" class="size-4">ダクト等の隙間</label>
        </div>
      </section>

      <section class="p-4 md:p-6 rounded-2xl bg-white dark:bg-slate-800 shadow-sm">
        <h2 class="text-lg font-semibold mb-4">4) 期待する効果・制約</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <span class="text-sm block mb-1">直接効果（複数選択可）</span>
            <label class="flex items-center gap-2"><input type="checkbox" name="effect" value="clarity_meeting" class="size-4">会議の聞き取り</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="effect" value="clarity_web" class="size-4">Web会議の聞き取り</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="effect" value="speaking" class="size-4">話しやすさ</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="effect" value="focus" class="size-4">集中力向上</label>
          </div>
          <div>
            <span class="text-sm block mb-1">業務・体験効果</span>
            <label class="flex items-center gap-2"><input type="checkbox" name="effect" value="productivity" class="size-4">生産性アップ</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="effect" value="comfort" class="size-4">快適性・満足度</label>
          </div>
          <div>
            <span class="text-sm block mb-1">戦略的効果</span>
            <label class="flex items-center gap-2"><input type="checkbox" name="effect" value="brand" class="size-4">ブランド価値</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="effect" value="innov" class="size-4">先進的オフィスイメージ</label>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
          <label class="block">
            <span class="text-sm">改修許容（施工可否）</span>
            <select name="work" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
              <option value="night">夜間可</option><option value="weekend">週末のみ</option><option value="inhours">営業時間内のみ</option>
            </select>
          </label>
          <label class="block">
            <span class="text-sm">完全遮音（音漏れゼロ）希望</span>
            <select name="zeroLeak" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
              <option value="no">いいえ</option><option value="yes">はい</option>
            </select>
          </label>
          <label class="block">
            <span class="text-sm">自己評価：現状の音環境（0=悪い〜10=良い）</span>
            <input name="selfScore" type="number" min="0" max="10" value="5" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent" />
          </label>
        </div>
      </section>

      <div class="md:col-span-2 flex flex-wrap gap-3 justify-end">
        <button type="button" id="resetBtn" class="px-4 py-2 rounded-xl border border-slate-300 dark:border-slate-700">リセット</button>
        <button type="button" id="diagnoseBtn" class="px-5 py-2.5 rounded-xl bg-emerald-600 text-white">診断する</button>
      </div>
    </form>

    <section id="result" class="mt-10 p-4 md:p-6 rounded-2xl bg-white dark:bg-slate-800 shadow-sm">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold">診断結果</h2>
        <div class="flex gap-2">
          <button id="downloadJson" class="px-3 py-2 rounded-xl border border-slate-300 dark:border-slate-700 text-sm">JSONダウンロード</button>
          <button id="printBtn" class="px-3 py-2 rounded-xl bg-slate-900 text-white text-sm dark:bg-slate-100 dark:text-slate-900">印刷 / PDF</button>
        </div>
      </div>

      <div id="proposalSummary" class="mt-4"></div>
      <div id="evidenceWrap" class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4"></div>
      <div id="recommendWrap" class="mt-6 grid grid-cols-1 lg:grid-cols-3 gap-4"></div>
      <div id="iwasemiWrap" class="mt-6"></div>
      <div id="notesWrap" class="mt-6"></div>
      
      <div id="rtChartWrap" class="mt-6 p-4 md:p-5 rounded-2xl border border-slate-200 dark:border-slate-700" style="display: none;">
        <h3 class="text-lg font-semibold mb-3">残響時間 推定グラフ</h3>
        <p class="text-sm text-slate-600 dark:text-slate-300 mb-3">
          現状の推定残響時間と、iwasemi設置後の推定残響時間（標準プラン）を周波数別に比較します。
          <br>※250Hz, 2000-8000Hzの吸音率は500/1000Hzの値を元にした簡易推定値です。
        </p>
        <div style="width: 100%; height: 300px;">
          <canvas id="rtChart"></canvas>
        </div>
      </div>
      
    </section>

    <footer class="text-sm text-slate-500 dark:text-slate-400 mt-10">
      © iwasemi demo. 本診断は目安です。吸音は簡易概算（サビーン式）。遮音/マスキング/AVは別途見積。
    </footer>
  </div>

  <script>
    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));

    // --- テーマ設定 ---
    const themeBtn = $('#themeToggle');
    function setTheme(mode){
      if(mode==='dark'){ document.documentElement.classList.add('dark'); localStorage.setItem('theme','dark'); }
      else { document.documentElement.classList.remove('dark'); localStorage.setItem('theme','light'); }
    }
    themeBtn.addEventListener('click',()=>{ const next = document.documentElement.classList.contains('dark') ? 'light':'dark'; setTheme(next); });
    setTheme(localStorage.getItem('theme')|| (window.matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light'));

    // --- プログレスバー ---
    const formEl = $('#diagForm');
    const progressBar = $('#progressBar');
    function updateProgress(){
      const required = $$('input[required], select[required]', formEl);
      const filled = required.filter(i=> i.value && i.value.trim()!=='' );
      const p = required.length ? Math.round((filled.length / required.length) * 100) : 100;
      progressBar.style.width = Math.min(100, Math.max(10,p)) + '%';
    }
    formEl.addEventListener('input', updateProgress); updateProgress();

    // --- ユーティリティ ---
    function getAllChecked(name){ return $$("input[name='"+name+"']:checked").map(i=>i.value); }
    function yen(n){ return '¥' + (Math.round(n)||0).toLocaleString('ja-JP'); }
    function fmt2(n){ return (Math.round(n*100)/100).toFixed(2); }
    function enc(s){ return encodeURIComponent(s||''); }

    // --- フォームデータ収集 ---
    function collect(){
      const fd = new FormData(formEl);
      return {
        company: fd.get('company')||'', projectName: fd.get('projectName')||'', person: fd.get('person')||'', email: fd.get('email')||'',
        agentBranch: fd.get('agentBranch')||'', industry: fd.get('industry')||'', size: fd.get('size')||'',
        pref: fd.get('pref')||'', timeline: fd.get('timeline')||'未定',
        project: fd.get('project')||'既存', category: fd.get('category')||'office', spaceType: fd.get('spaceType')||'meeting_closed',
        uses: getAllChecked('use'), sources: getAllChecked('source'), complaint: fd.get('complaint')||'mid', measures: getAllChecked('measure'),
        area: Number(fd.get('area')||0), rooms: Number(fd.get('rooms')||1), ceilHeight: fd.get('ceilHeight')||'2_5_3_0',
        walls: [fd.get('wall1')||'gypsum', fd.get('wall2')||'gypsum', fd.get('wall3')||'gypsum', fd.get('wall4')||'gypsum'],
        floor: fd.get('floor')||'carpet', ceiling: fd.get('ceiling')||'pb', door: fd.get('door')||'wood_solid',
        doorSeal: fd.get('doorSeal')||'gasket', glazing: fd.get('glazing')||'single',
        features: getAllChecked('feature'), effects: getAllChecked('effect'), work: fd.get('work')||'night',
        zeroLeak: fd.get('zeroLeak')==='yes', selfScore: Number(fd.get('selfScore')||5)
      };
    }

    // --- 吸音・残響計算ロジック ---

    // 周波数帯 (Hz)
    const FREQS = [250, 500, 1000, 2000, 4000, 8000];
    const FREQ_LABELS = FREQS.map(f => f + 'Hz');

    // iwasemiパネルの仮定吸音率 (周波数帯 FREQS に対応)
    const PANEL_ALPHA_FREQS = [0.35, 0.55, 0.75, 0.80, 0.70, 0.65];

    /**
     * 素材の吸音率定義 (500Hz, 1000Hz)
     * @description calcRT内で6帯域に拡張されます
     */
    const alpha_base = {
      gypsum:{a500:0.06,a1000:0.06}, rc:{a500:0.02,a1000:0.02}, glass_s:{a500:0.15,a1000:0.10},
      glass_d:{a500:0.12,a1000:0.10}, abs_finish:{a500:0.30,a1000:0.30}, wood:{a500:0.10,a1000:0.08},
      unknown:{a500:0.06,a1000:0.06},
      carpet:{a500:0.21,a1000:0.26}, wood_f:{a500:0.10,a1000:0.08}, pvc:{a500:0.02,a1000:0.02},
      tile_stone:{a500:0.02,a1000:0.02}, floor_unknown:{a500:1.0,a1000:0.08}, // 0.10 -> 1.0 (typo?) 修正: 0.10
      pb:{a500:0.10,a1000:0.08}, mineral_grid:{a500:0.60,a1000:0.70}, metal:{a500:0.10,a1000:0.10},
      exposed:{a500:0.05,a1000:0.05}, ceil_unknown:{a500:0.10,a1000:0.08}
    };
    // floor_unknown のタイポらしき箇所を修正
    alpha_base.floor_unknown.a500 = 0.10;

    /**
     * 500/1000Hzの吸音率データから6帯域の吸音率配列を生成する
     * @param {object} base - {a500, a1000}
     * @returns {number[]} - 6帯域 (FREQS) の吸音率配列
     */
    function extendAlphaTo6Bands(base) {
      const a500 = base.a500 || 0.05;
      const a1000 = base.a1000 || 0.05;
      // 仮定ルール:
      // 250Hz -> a500
      // 500Hz -> a500
      // 1000Hz -> a1000
      // 2000Hz -> a1000
      // 4000Hz -> a1000
      // 8000Hz -> a1000
      return [a500, a500, a1000, a1000, a1000, a1000];
    }

    // 6帯域の吸音率データオブジェクトを生成
    const alpha = {};
    for (const key in alpha_base) {
      alpha[key] = extendAlphaTo6Bands(alpha_base[key]);
    }

    // --- 吸音率取得ヘルパー (6帯域配列を返すように修正) ---
    const getAlphaWall = k => alpha[k] || alpha.gypsum;
    function getAlphaFloor(k) {
      if (k === 'carpet') return alpha.carpet;
      if (k === 'wood') return alpha.wood_f;
      if (k === 'pvc') return alpha.pvc;
      if (k === 'tile_stone') return alpha.tile_stone;
      return alpha.floor_unknown;
    }
    const getAlphaCeil = k => alpha[k] || alpha.ceil_unknown;


    function heightFromKey(k){ if(k==='lt2_5')return 2.4; if(k==='2_5_3_0')return 2.75; if(k==='3_0_3_5')return 3.25; if(k==='gt3_5')return 3.8; return 2.7; }
    function rtTarget(spaceType, uses){
      let t=0.6;
      if(spaceType==='meeting_closed'||spaceType==='meeting_transom') t=0.5;
      else if(spaceType==='booth_tel'||spaceType==='booth_built') t=0.35;
      else if(spaceType==='open'||spaceType==='callcenter') t=0.7;
      else if(spaceType==='studio') t=0.3;
      if(uses.includes('stream')) t*=0.85;
      if(uses.includes('music')) t*=0.9;
      return t;
    }

    /**
     * 残響時間を6帯域で計算する (改修版)
     */
    function calcRT(d){
      const A=Math.max(0.1,d.area), H=heightFromKey(d.ceilHeight), V=A*H, s=Math.sqrt(A);
      const wallAreas=[s*H,s*H,s*H,s*H], floorArea=A, ceilArea=A;
      
      const aw=d.walls.map(getAlphaWall), af=getAlphaFloor(d.floor), ac=getAlphaCeil(d.ceiling);
      
      // 6帯域の等価吸音面積 (Aeq) を計算
      const Aeq_values = FREQS.map((freq, i) => {
        const Aeq_wall = aw[0][i]*wallAreas[0] + aw[1][i]*wallAreas[1] + aw[2][i]*wallAreas[2] + aw[3][i]*wallAreas[3];
        const Aeq_floor = af[i] * floorArea;
        const Aeq_ceil = ac[i] * ceilArea;
        return Aeq_wall + Aeq_floor + Aeq_ceil;
      });

      // 6帯域の残響時間 (T) を計算
      const T_values = Aeq_values.map(Aeq => 0.161 * V / Math.max(0.001, Aeq));

      // 互換性のため、500Hz(index:1)と1000Hz(index:2)の値を個別に返す
      return {
        V, A, H, s, wallAreas, floorArea, ceilArea, 
        Aeq_values, // [Aeq_250, Aeq_500, Aeq_1000, ...]
        T_values,   // [T_250, T_500, T_1000, ...]
        Aeq500: Aeq_values[1], Aeq1000: Aeq_values[2],
        T500: T_values[1], T1000: T_values[2]
      };
    }

    function scoreAbs(d, rt){
      const Ttgt=rtTarget(d.spaceType,d.uses), Tavg=(rt.T500+rt.T1000)/2;
      const ratio=Math.max(0,Math.min(2.0,Tavg/Ttgt));
      let s=Math.max(0,Math.min(100,(ratio-1.0)*100));
      const U=new Set(d.uses);
      if(U.has('meeting_web')||U.has('meeting_hybrid')||U.has('websolo')) s+=5;
      return Math.round(Math.max(0,Math.min(100,s)));
    }

    // --- 遮音スコア計算 (変更なし) ---
    function isolationIndicators(d){
      const ind={
        extInvasion:d.sources.includes('invasion_ext')?1:0,
        transom:d.features.includes('transom')?1:0,
        plenum:d.features.includes('shared_plenum')?1:0,
        grille:d.features.includes('grille')?1:0,
        gaps:['gap_door_bottom','gap_frame','gap_penetration','gap_duct'].some(k=>d.features.includes(k))?1:0
      };
      return {indicators:ind, any:Object.values(ind).some(v=>v===1)};
    }
    function wallStatsForIsl(walls){
      const cnt=t=>walls.filter(w=>t.includes(w)).length;
      return {glassCount:cnt(['glass_s','glass_d']), rcCount:cnt(['rc'])};
    }
    function scoreIsl(d, rt){
      let s=0;
      const {indicators:anys, any}=isolationIndicators(d), ind=anys;
      const ws=wallStatsForIsl(d.walls);
      if(ind.transom) s+=28; if(ind.plenum) s+=28; if(ind.grille) s+=22; if(ind.gaps) s+=12;
      if(ind.extInvasion) s+=24;
      if(d.door==='wood_honeycomb') s+=12;
      if(d.door==='glass_s'||d.door==='glass_d') s+=10;
      if(d.door==='steel') s-=8;
      if(d.doorSeal==='gap') s+=10;
      if(d.doorSeal==='gasket') s-=5;
      if(d.glazing==='single') s+=8;
      if(d.glazing==='double') s-=6;
      if(ws.glassCount>=2) s+=8; else if(ws.glassCount===1) s+=5;
      if(ws.rcCount>=2) s-=8;
      const privacyUse=['exec','external']; if(privacyUse.some(u=>d.uses.includes(u))) s+= any?6:3;
      if(!any) s=Math.min(s,35);
      const Ttgt=rtTarget(d.spaceType,d.uses), Tavg=(rt.T500+rt.T1000)/2, ratio=Tavg/Ttgt, idi=s;
      if(ratio>=1.5 && idi<40) s*=0.5; else if(ratio>=1.3 && idi<50) s*=0.7;
      return Math.max(0,Math.round(s));
    }

    // --- iwasemiパネル計算 (変更なし) ---
    const UNIT_PRICE=5000, PANEL_AREA=0.050625, PANEL_ALPHA_500=0.553333, PANEL_ALPHA_1000=0.753333, PANEL_ALPHA_AVG=(PANEL_ALPHA_500+PANEL_ALPHA_1000)/2;
    function requiredPanelsFromDelta(deltaAeq){ const perPanel=PANEL_AREA*PANEL_ALPHA_AVG; return Math.max(0,Math.ceil(deltaAeq/Math.max(1e-6,perPanel))); }

    function buildPanelSolutions(d, primaryKey, rt){
      const Ttgt=rtTarget(d.spaceType,d.uses), V=rt.V, Aeq_now=(rt.Aeq500+rt.Aeq1000)/2, Aeq_need=0.161*V/Ttgt, delta=Math.max(0,Aeq_need-Aeq_now);
      const basePanels=requiredPanelsFromDelta(delta);
      const variants=[{name:'標準',factor:1.00},{name:'強め',factor:1.20}].map(v=>{
        const panels=Math.max(1,Math.round(basePanels*v.factor));
        const pricePanels=panels*UNIT_PRICE;
        const bom=[{name:'iwasemi パネル（代表）',qty:panels,price:pricePanels}];
        let extras=0;
        if(primaryKey==='abs_plus_seal'||primaryKey==='isolation'){ const rooms=Math.max(1,Math.round(d.rooms)); const sealCost=15000*rooms; bom.push({name:'隙詰めセット（ドア/枠・部屋数相当）',qty:rooms,price:sealCost}); extras+=sealCost; }
        const install=Math.round(pricePanels*0.20); bom.push({name:'仮設・夜間施工（概算）',qty:1,price:install});
        return {name:v.name,panels,bom,subtotal:pricePanels+extras+install};
      });
      return { basePanels, deltaAeq:delta, Ttgt, V, Aeq_now, Aeq_need, plans:variants };
    }

    // --- 推奨ロジック (変更なし) ---
    function recommend(d,S,rt){
      const list=[], ratio=((rt.T500+rt.T1000)/2)/rtTarget(d.spaceType,d.uses);
      if(S.S_isl>=60){
        list.push({key:'isolation',label:'遮音',priority:'高',score:S.S_isl,reason:'欄間/共有天井/ガラリ/隙間/外部からの音の侵入が見られるため、二次経路を含む遮音対策が優先です（上部インフィル・扉更新等）。',estimate:{min:null,max:null,currency:'JPY'},cta:{label:'遮音工事の社内見積を依頼',kind:'okamura'}});
      }else if(S.S_isl>=45){
        list.push({key:'abs_plus_seal',label:'吸音＋隙詰め',priority:'高',score:S.S_isl+Math.min(12,0.25*S.S_abs),reason:'侵入・回り込みの懸念があるため、隙詰めを併用しつつ吸音で室内音圧と残響を低減します。',estimate:{min:null,max:null,currency:'JPY'},cta:{label:'隙詰め同時で相談（PxDT）',kind:'pxdt'}});
      }else if(ratio>=1.3 && S.S_isl<50){
        list.push({key:'absorption',label:'吸音',priority:'高',score:S.S_abs+(d.uses.includes('stream')?5:0),reason:'残響が目標値を上回っており、可聴性・明瞭度の改善には吸音量の増強が有効です。',estimate:{min:null,max:null,currency:'JPY'},cta:{label:'有償トライアルを申し込む',kind:'trial'}});
      }else if((d.spaceType==='open'||d.spaceType==='callcenter')&&d.complaint==='high'&&S.S_abs<50){
        list.push({key:'masking',label:'サウンドマスキング',priority:'高',score:55,reason:'常時ざわつきの低減と会話プライバシー向上のため、吸音と併用した背景音制御を推奨します。',estimate:{min:null,max:null,currency:'JPY'},cta:{label:'社内（マスキング）相談',kind:'okamura'}});
      }else{
        list.push({key:'measure',label:'計測/トライアル',priority:'高',score:50,reason:'境界条件のため、残響測定または体感トライアルで効果を事前検証します。',estimate:{min:null,max:null,currency:'JPY'},cta:{label:'PxDTに相談',kind:'pxdt'}});
      }
      const hasAbs=list.some(x=>x.key==='absorption'||x.key==='abs_plus_seal');
      if(!hasAbs){
        list.push({key:'absorption',label:'吸音',priority:'中',score:Math.max(30,S.S_abs),reason:'室内整音の基礎として吸音を段階導入します。',estimate:{min:null,max:null,currency:'JPY'},cta:{label:'有償トライアルを申し込む',kind:'trial'}});
      }
      if(!list.some(x=>x.key==='isolation')&&S.S_isl>=40){
        list.push({key:'abs_plus_seal',label:'吸音＋隙詰め',priority:'低',score:S.S_isl,reason:'軽微な回り込み対策を同時に行うと改善が早期化します。',estimate:{min:null,max:null,currency:'JPY'},cta:{label:'隙詰め同時で相談（PxDT）',kind:'pxdt'}});
      }
      list.sort((a,b)=>b.score-a.score);
      return list.slice(0,3);
    }

    // --- 結果クリア (グラフエリアもクリア) ---
    function clearResult(){
      $('#proposalSummary').innerHTML=''; 
      $('#evidenceWrap').innerHTML=''; 
      $('#recommendWrap').innerHTML=''; 
      $('#iwasemiWrap').innerHTML=''; 
      $('#notesWrap').innerHTML='';
      // グラフエリアを非表示にし、既存のグラフインスタンスを破棄
      $('#rtChartWrap').style.display = 'none';
      if (window.myRtChart) {
        window.myRtChart.destroy();
        window.myRtChart = null;
      }
    }

    // --- 結果描画 (変更なし) ---
    function renderProposalSummary(d,recs,S,rt,panelSol){
      const top=recs[0];
      let priceLine=`<span class="badge bg-white/60 dark:bg-slate-800/60">別途見積</span>`;
      if(top.key==='absorption'||top.key==='abs_plus_seal'){
        const std=panelSol.plans.find(p=>p.name==='標準')?.subtotal||0, pro=panelSol.plans.find(p=>p.name==='強め')?.subtotal||0;
        priceLine=`<span class="tabular-nums font-semibold">${yen(std)}〜${yen(pro)}</span> <span class="text-xs text-slate-500">（概算・税抜）</span>`;
      }
      const ctas=[
        top.key==='absorption'?{label:'有償トライアルを申し込む',kind:'trial'}:null,
        top.key==='abs_plus_seal'?{label:'隙詰め同時で相談（PxDT）',kind:'pxdt'}:null,
        top.key==='isolation'?{label:'遮音工事の社内見積を依頼',kind:'okamura'}:null,
        top.key==='masking'?{label:'マスキングの社内相談',kind:'okamura'}:null
      ].filter(Boolean);

      $('#proposalSummary').innerHTML=`
        <div class="p-4 md:p-5 rounded-2xl border border-emerald-300/50 bg-emerald-50/60 dark:bg-emerald-900/20 dark:border-emerald-700">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
            <div>
              <div class="text-sm text-emerald-900/80 dark:text-emerald-100/80">今回のご提案（結論）</div>
              <div class="mt-1 text-xl font-semibold">解決カテゴリ：${top.label} <span class="badge">${top.priority}</span></div>
              <p class="text-sm mt-1 text-emerald-900/85 dark:text-emerald-100/85">${top.reason}</p>
            </div>
            <div class="text-right">
              <div class="text-xs text-slate-500">概算見積</div>
              <div class="text-lg">${priceLine}</div>
            </div>
          </div>
          <div class="mt-3 flex flex-wrap gap-2">
            ${ctas.map(c=>`<button class="px-3 py-2 rounded-xl bg-slate-900 text-white text-sm dark:bg-slate-100 dark:text-slate-900" onclick="handleCTA('${c.kind}')">${c.label}</button>`).join('')}
          </div>
        </div>`;
    }

    function evidenceLines(d,S,rt){
      const Ttgt=rtTarget(d.spaceType,d.uses), Tavg=(rt.T500+rt.T1000)/2, ratio=Tavg/Ttgt, feats=[];
      if(d.features.includes('transom')) feats.push('欄間オープン');
      if(d.features.includes('shared_plenum')) feats.push('共有天井裏');
      if(d.features.includes('grille')) feats.push('ガラリ/換気開口');
      if(['gap_door_bottom','gap_frame','gap_penetration','gap_duct'].some(x=>d.features.includes(x))) feats.push('隙間あり');
      if(d.sources.includes('invasion_ext')) feats.push('外部からの音の侵入');
      return [
        `残響：平均 ${fmt2(Tavg)}s / 目標 ${fmt2(Ttgt)}s（比 ${fmt2(ratio)}）`,
        `吸音必要度 S_abs=${S.S_abs}・遮音必要度 S_isl=${S.S_isl}`,
        `回り込みの要因：${feats.length?feats.join('・'):'特になし'}`
      ];
    }

    function renderEvidence(d,S,rt){
      const lines=evidenceLines(d,S,rt);
      $('#evidenceWrap').innerHTML=`
        <div class="p-4 rounded-xl bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700">
          <div class="text-sm text-slate-500 mb-1">① サマリ指標</div>
          <div class="text-2xl font-bold">S_abs ${S.S_abs} / S_isl ${S.S_isl}</div>
          <div class="text-xs text-slate-500 mt-1">${d.company || '（未入力）'}・${d.projectName || '（案件名未入力）'}／${d.person || ''}</div>
          <div class="text-xs text-slate-500 mt-1">${d.rooms}室・${d.area}m²/室</div>
        </div>
        <div class="p-4 rounded-xl bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700">
          <div class="text-sm text-slate-500 mb-1">② 残響・目標</div>
          <div class="text-sm">${lines[0]}</div>
          <div class="text-xs text-slate-500 mt-2">500Hz=${fmt2(rt.T500)}s（Aeq=${fmt2(rt.Aeq500)}m²） / 1000Hz=${fmt2(rt.T1000)}s（Aeq=${fmt2(rt.Aeq1000)}m²）</div>
        </div>
        <div class="p-4 rounded-xl bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700">
          <div class="text-sm text-slate-500 mb-1">③ 侵入・回り込み</div>
          <div class="text-sm">${lines[2]}</div>
          <div class="text-xs text-slate-500 mt-2">扉:${d.door}／隙間処理:${d.doorSeal}／ガラス:${d.glazing}</div>
        </div>`;
    }

    function renderRecommendations(recs,panelSol,primaryKey){
      $('#recommendWrap').innerHTML=recs.map(r=>{
        let priceHtml=`<span class="badge bg-white/60 dark:bg-slate-800/60">別途見積</span>`, bomHtml='';
        if(r.key==='absorption'||r.key==='abs_plus_seal'){
          const std=panelSol.plans.find(p=>p.name==='標準'), pro=panelSol.plans.find(p=>p.name==='強め');
          priceHtml=`${yen(std.subtotal)}〜${yen(pro.subtotal)} <span class="text-xs text-slate-500">（概算・税抜）</span>`;
          const makeBom=b=>b.map(x=>`<div class="flex items-center justify-between text-sm"><span>${x.name} × <b>${x.qty}</b></span><span class="tabular-nums">${yen(x.price)}</span></div>`).join('');
          bomHtml=`<div class="mt-2"><div class="text-xs text-slate-500 mb-1">構成（標準）</div>${makeBom(std.bom)}</div>`;
        }
        const badge=`<span class="badge">${r.priority}</span>`;
        return `
          <div class="p-4 rounded-2xl border border-slate-200 dark:border-slate-700 bg-white/50 dark:bg-slate-800/60">
            <div class="flex items-baseline justify-between mb-1">
              <div class="text-base font-semibold">解決カテゴリ：${r.label} ${badge}</div>
              <div class="text-xs text-slate-500">スコア：${Math.round(r.score)}</div>
            </div>
            <p class="text-sm text-slate-700 dark:text-slate-200">${r.reason}</p>
            <div class="mt-2"><span class="text-xs text-slate-500">概算見積：</span><span class="text-base font-semibold tabular-nums">${priceHtml}</span></div>
            ${bomHtml}
            <button class="mt-3 w-full px-3 py-2 rounded-xl bg-emerald-600 text-white text-sm" onclick="handleCTA('${r.cta.kind}')">${r.cta.label}</button>
          </div>`;
      }).join('');
    }

    function renderIwasemiDetail(d,panelSol,primaryKey){
      const std=panelSol.plans.find(p=>p.name==='標準'), pro=panelSol.plans.find(p=>p.name==='強め');
      const makeBom=b=>b.map(x=>`<div class="flex items-center justify-between text-sm"><span>${x.name} × <b>${x.qty}</b></span><span class="tabular-nums">${yen(x.price)}</span></div>`).join('');
      $('#iwasemiWrap').innerHTML=`
        <div class="p-4 md:p-5 rounded-2xl border border-slate-200 dark:border-slate-700">
          <div class="text-lg font-semibold mb-1">iwasemiの場合の見積内容</div>
          <p class="text-sm text-slate-600 dark:text-slate-300 mb-3">数量・代表種類、工法（仮設/夜間施工を含む）、概算金額を表示します。製品明細はご要望に応じてRC-α / SQ-α / HX-α等で最適化します。</p>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="p-4 rounded-xl bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700">
              <div class="font-semibold mb-2">標準プラン</div>
              ${makeBom(std.bom)}
              <div class="mt-2 flex items-center justify-between pt-2 border-t border-slate-200 dark:border-slate-700"><span class="text-sm">小計</span><span class="text-lg font-bold">${yen(std.subtotal)}</span></div>
            </div>
            <div class="p-4 rounded-xl bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700">
              <div class="font-semibold mb-2">強めプラン</div>
              ${makeBom(pro.bom)}
              <div class="mt-2 flex items-center justify-between pt-2 border-t border-slate-200 dark:border-slate-700"><span class="text-sm">小計</span><span class="text-lg font-bold">${yen(pro.subtotal)}</span></div>
            </div>
          </div>
          <p class="text-xs text-slate-500 mt-3">※ 価格は概算（税抜）。仕上げ・物流・現場条件で変動します。隙詰めはドア/枠・貫通部等の簡易遮音です。</p>
        </div>`;
    }

    function renderNotes(primaryKey){
      const notes=[];
      if(primaryKey==='isolation') notes.push('遮音工事（欄間・共有天井のインフィル、扉更新、二重ガラス等）は別途社内見積が必要です。');
      if(primaryKey==='abs_plus_seal') notes.push('「隙詰め」はドア下・枠まわり・貫通部等の簡易遮音を指します。吸音との併用で体感改善を早期化します。');
      $('#notesWrap').innerHTML=`
        <div class="p-4 rounded-2xl bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700">
          <div class="font-semibold mb-1">注意・前提</div>
          <ul class="list-disc pl-5 space-y-1 text-sm text-slate-600 dark:text-slate-300">
            <li>残響時間はサビーン式の簡易推定です（500/1000Hz平均）。形状・家具・在室人数で変動します。</li>
            ${notes.map(n=>`<li>${n}</li>`).join('')}
            <li>サウンドマスキング、AV機器、建築遮音は専門部署と連動します。</li>
          </ul>
        </div>`;
    }

    // --- 【新規】グラフ描画関数 ---
    /**
     * @param {object} d - フォーム入力データ
     * @param {object} rt_before - 現状の計算結果 (calcRT の戻り値)
     * @param {object} panelSol - iwasemi提案 (buildPanelSolutions の戻り値)
     */
    function renderRTChart(d, rt_before, panelSol) {
      try {
        // --- 設置後の残響時間を計算 ---
        
        // 1. 標準プランのパネル枚数を取得
        const std_panels = panelSol.plans.find(p=>p.name==='標準')?.panels || panelSol.basePanels;
        
        // 2. パネルによって追加される等価吸音面積 (6帯域) を計算
        //    追加Aeq = パネル吸音率[i] * パネル面積 * パネル枚数
        const added_Aeq_std = PANEL_ALPHA_FREQS.map(alpha_panel => {
          return alpha_panel * PANEL_AREA * std_panels;
        });

        // 3. 設置後の残響時間 (6帯域) を計算
        //    T_after = 0.161 * V / (Aeq_before[i] + added_Aeq_std[i])
        const T_after_std = rt_before.Aeq_values.map((Aeq_before, i) => {
          const Aeq_total = Aeq_before + added_Aeq_std[i];
          return 0.161 * rt_before.V / Math.max(0.001, Aeq_total);
        });

        // --- 目標残響時間 (全帯域共通) ---
        const T_target_line = Array(FREQS.length).fill(panelSol.Ttgt);

        // --- Chart.js でグラフを描画 ---
        const ctx = $('#rtChart').getContext('2d');
        
        // 既存のグラフがあれば破棄
        if (window.myRtChart) {
          window.myRtChart.destroy();
        }
        
        // ダークモード判定
        const isDark = document.documentElement.classList.contains('dark');
        const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
        const labelColor = isDark ? 'rgba(255, 255, 255, 0.7)' : 'rgba(0, 0, 0, 0.7)';

        window.myRtChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: FREQ_LABELS,
            datasets: [
              {
                label: '現状（推定）',
                data: rt_before.T_values.map(fmt2), // データをフォーマット
                borderColor: 'rgb(107, 114, 128)', // slate-500
                backgroundColor: 'rgba(107, 114, 128, 0.1)',
                fill: false,
                tension: 0.1
              },
              {
                label: 'iwasemi設置後（標準）',
                data: T_after_std.map(fmt2), // データをフォーマット
                borderColor: 'rgb(16, 185, 129)', // emerald-500
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                fill: false,
                tension: 0.1,
                borderWidth: 2
              },
              {
                label: '目標残響時間',
                data: T_target_line.map(fmt2), // データをフォーマット
                borderColor: 'rgb(239, 68, 68)', // red-500
                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                fill: false,
                borderDash: [5, 5], // 破線
                pointRadius: 0,
                borderWidth: 1.5
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                title: {
                  display: true,
                  text: '残響時間 (s)',
                  color: labelColor
                },
                ticks: { 
                  color: labelColor,
                  callback: function(value) { return fmt2(value) + 's'; }
                },
                grid: { color: gridColor },
                min: 0
              },
              x: {
                title: {
                  display: true,
                  text: '周波数 (Hz)',
                  color: labelColor
                },
                ticks: { color: labelColor },
                grid: { color: gridColor }
              }
            },
            plugins: {
              legend: {
                labels: { color: labelColor }
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return `${context.dataset.label}: ${context.formattedValue} s`;
                  }
                }
              }
            }
          }
        });

        // グラフエリアを表示
        $('#rtChartWrap').style.display = 'block';

      } catch (e) {
        console.error('グラフの描画に失敗しました:', e);
        $('#rtChartWrap').style.display = 'none'; // エラー時は非表示
      }
    }


    // --- CTA (変更なし) ---
    function makeMailto(subject, body){ return `mailto:?subject=${enc(subject)}&body=${enc(body)}`; }
    function handleCTA(kind){
      const payload=window.__diagResult, lines=[];
      if(payload){
        const {input,scores,recommendations}=payload, Ttgt=rtTarget(input.spaceType,input.uses);
        lines.push(`[案件] ${input.company} / ${input.projectName} / ${input.person}`);
        lines.push(`[空間] ${input.spaceType}, ${input.area}m² x ${input.rooms}室, 天井:${input.ceilHeight}`);
        lines.push(`[指標] S_abs ${scores.S_abs} / S_isl ${scores.S_isl} / 目標RT ${fmt2(Ttgt)}s`);
        lines.push(`[提案] ${recommendations.map(r=>r.label+'('+r.priority+')').join(' > ')}`);
      }
      const summary=lines.join('\n');
      if(kind==='trial'){ alert('有償トライアル（前決済）フローへ遷移する想定です。'); }
      else if(kind==='pxdt'){ window.location.href = makeMailto('【iwasemi】PxDT相談', summary + '\n\n※JSONは診断画面の「JSONダウンロード」から添付してください。'); }
      else if(kind==='okamura'){ window.location.href = makeMailto('【iwasemi】社内見積依頼（遮音/マスキング）', summary + '\n\n欄間・共有天井・ガラリ・隙間の有無、扉/ガラスの仕様を確認ください。'); }
    }
    window.handleCTA=handleCTA;

    // --- 診断実行 (グラフ描画を追加) ---
    function diagnose(){
      const d=collect();
      // 1. 現状の残響時間 (6帯域) を計算
      const rt=calcRT(d);
      
      // 2. スコア計算
      const S={S_abs:scoreAbs(d,rt), S_isl:scoreIsl(d,rt)};
      
      // 3. 推奨とパネル枚数を計算 (500/1000Hz平均ベース)
      const recs=recommend(d,S,rt);
      const primaryKey=recs[0]?.key||'absorption';
      const panelSol=buildPanelSolutions(d,primaryKey,rt);

      // 4. 結果をクリア
      clearResult();
      
      // 5. 結果を描画
      renderProposalSummary(d,recs,S,rt,panelSol);
      renderEvidence(d,S,rt);
      renderRecommendations(recs,panelSol,primaryKey);
      if(['absorption','abs_plus_seal'].includes(primaryKey)) renderIwasemiDetail(d,panelSol,primaryKey);
      renderNotes(primaryKey);
      
      // 6. 【新規】グラフを描画
      renderRTChart(d, rt, panelSol);

      // 7. グローバルに結果を保存
      window.__diagResult={input:d,scores:S,rt,recommendations:recs,panels:panelSol};
      window.location.hash='#result';
    }

    // --- イベントリスナー ---
    $('#diagnoseBtn').addEventListener('click', diagnose);
    $('#resetBtn').addEventListener('click', ()=>{ formEl.reset(); updateProgress(); clearResult(); });

    $('#downloadJson').addEventListener('click', ()=>{
      const payload=window.__diagResult||{note:'先に「診断する」を押してください。'};
      const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
      const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`iwasemi-diagnosis-${Date.now()}.json`;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });
    $('#printBtn').addEventListener('click', ()=> window.print());

    // ページ読み込み時に診断を実行
    window.addEventListener('DOMContentLoaded', ()=> { try { diagnose(); } catch(e){} });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>iwasemi｜音問題 診断サービス（フォーム連携＋事例連携）</title>

  <!-- Noto Sans JP -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['"Noto Sans JP"','"Noto Sans"','ui-sans-serif','system-ui',
                   '-apple-system','"Hiragino Kaku Gothic ProN"','Meiryo','sans-serif']
          }
        }
      }
    }
  </script>

  <!-- Chart.js（グラフで使用） -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{ color-scheme: light dark; }
    .badge{display:inline-block;padding:.125rem .5rem;border-radius:.5rem;font-size:.75rem;border:1px solid rgba(16,185,129,.35)}
    .toast{position:fixed;right:1rem;bottom:1rem;background:#0f172a;color:#fff;padding:.75rem 1rem;border-radius:.75rem;opacity:.96;z-index:70}
    .toast.ok{background:#065f46}.toast.ng{background:#7f1d1d}

    /* Tips */
    .tips-overlay{position:fixed;inset:0;z-index:80;display:none;background:rgba(15,23,42,.96);color:#fff}
    .tips-body{max-width:44rem;margin:8vh auto;padding:1.5rem}
    .tips-card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.15);border-radius:1rem;padding:1.25rem}
    .tips-actions{display:flex;gap:.5rem;justify-content:flex-end;margin-top:1rem}
    .tips-btn{background:#10b981;color:#0b1b26;border-radius:.75rem;padding:.5rem .9rem}
    .tips-btn.gray{background:#e2e8f0;color:#0b1b26}

    /* TELECUBE 画像（全体が入る・見切れ防止） */
    .telecube-img{
      width:100%; height:280px; object-fit:contain;
      background:#0b1220; border-radius:.75rem;
    }
    @media (min-width:1024px){
      .telecube-img{ height:320px; }
    }

    /* 250Hzを「半分見切らせる」ための左側オーバレイ（描画時に幅を算出） */
    .left-clip-overlay{
      position:absolute; inset-block:0; left:0; width:0;
      pointer-events:none; z-index:5; /* tooltip 等より下でOK */
    }
  </style>
</head>
<body class="font-sans bg-slate-50 text-slate-900 selection:bg-emerald-200/60 dark:bg-slate-900 dark:text-slate-50">
  <div class="max-w-6xl mx-auto p-4 md:p-8">

    <!-- HEADER -->
    <header class="flex items-center justify-between gap-4 mb-6">
      <div class="flex items-center gap-3">
        <div class="size-10 rounded-2xl bg-emerald-500/90 flex items-center justify-center text-white font-bold">i</div>
        <div>
          <h1 class="text-xl md:text-2xl font-bold">iwasemi™｜音問題 診断サービス</h1>
          <p class="text-sm text-slate-500 dark:text-slate-400">©Pixie Dust Technologies Inc.</p>
          <p class="text-sm text-slate-500 dark:text-slate-400">入力から残響・遮音の課題を解析し、最適解と概算・導入事例を自動提示します。</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="themeToggle" class="px-3 py-2 rounded-xl border border-slate-300/60 dark:border-slate-700 text-sm"></button>
        <a href="#result" class="px-3 py-2 rounded-xl bg-emerald-600 text-white text-sm">結果を見る</a>
      </div>
    </header>

    <!-- PROGRESS -->
    <div id="progress" class="w-full h-2 bg-slate-200 dark:bg-slate-800 rounded-full overflow-hidden mb-6">
      <div id="progressBar" class="h-full w-[0%] bg-emerald-500 transition-all"></div>
    </div>

    <!-- ===== FORM ===== -->
    <form id="diagForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">

      <!-- 1-A) 顧客情報 -->
      <section class="md:col-span-2 p-4 md:p-6 rounded-2xl bg-white dark:bg-slate-800 shadow-sm">
        <h2 class="text-lg font-semibold mb-4">顧客情報</h2>
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
          <label class="block md:col-span-2">
            <span class="text-sm">企業名（顧客）</span>
            <input name="company" required class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent" placeholder="株式会社○○"/>
          </label>
          <label class="block md:col-span-1">
            <span class="text-sm">業種</span>
            <select name="industry" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
              <option>IT</option><option>製造</option><option>金融</option><option>学校</option><option>医療</option>
              <option>官公庁</option><option>BPO/コール</option><option>商業</option><option>物流</option><option>その他</option>
            </select>
          </label>
          <label class="block md:col-span-1">
            <span class="text-sm">規模</span>
            <select name="size" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
              <option>〜100名</option><option>101–500</option><option>501–1000</option><option>1001–5000</option><option>5001〜</option>
            </select>
          </label>
          <label class="block md:col-span-1">
            <span class="text-sm">都道府県</span>
            <select name="pref" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
              <option value="">選択してください</option>
              <option>北海道</option><option>青森県</option><option>岩手県</option><option>宮城県</option><option>秋田県</option><option>山形県</option><option>福島県</option>
              <option>茨城県</option><option>栃木県</option><option>群馬県</option><option>埼玉県</option><option>千葉県</option><option>東京都</option><option>神奈川県</option>
              <option>新潟県</option><option>富山県</option><option>石川県</option><option>福井県</option><option>山梨県</option><option>長野県</option>
              <option>岐阜県</option><option>静岡県</option><option>愛知県</option><option>三重県</option>
              <option>滋賀県</option><option>京都府</option><option>大阪府</option><option>兵庫県</option><option>奈良県</option><option>和歌山県</option>
              <option>鳥取県</option><option>島根県</option><option>岡山県</option><option>広島県</option><option>山口県</option>
              <option>徳島県</option><option>香川県</option><option>愛媛県</option><option>高知県</option>
              <option>福岡県</option><option>佐賀県</option><option>長崎県</option><option>熊本県</option><option>大分県</option><option>宮崎県</option><option>鹿児島県</option><option>沖縄県</option>
            </select>
          </label>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mt-4">
          <label class="block md:col-span-1">
            <span class="text-sm">実施想定時期</span>
            <select name="timeline" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
              <option>今期</option><option>来期</option><option selected>未定</option>
            </select>
          </label>
          <label class="block md:col-span-2">
            <span class="text-sm">ご担当者名（顧客）</span>
            <input name="person" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent" placeholder="山田 太郎"/>
          </label>
          <label class="block md:col-span-2">
            <span class="text-sm">メール（結果送付先）</span>
            <input name="email" type="email" required class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent" placeholder="taro@example.com"/>
          </label>
        </div>
      </section>

      <!-- 1-B) 代理店担当者情報 -->
      <section class="md:col-span-2 p-4 md:p-6 rounded-2xl bg-white dark:bg-slate-800 shadow-sm">
        <h2 class="text-lg font-semibold mb-4">代理店担当者情報</h2>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <label class="block">
            <span class="text-sm">企業名（代理店）</span>
            <input name="agentCompany" required class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent" placeholder="○○販売株式会社"/>
          </label>
          <label class="block">
            <span class="text-sm">担当者名</span>
            <input name="agentPerson" required class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent" placeholder="代理店 太郎"/>
          </label>
          <label class="block">
            <span class="text-sm">支店名</span>
            <input name="agentBranch" required class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent" placeholder="○○支店 / ○○営業部"/>
          </label>
          <label class="block">
            <span class="text-sm">メールアドレス</span>
            <input name="agentEmail" type="email" required class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent" placeholder="agency@example.com"/>
          </label>
        </div>
      </section>

      <!-- 2) 空間の基本情報 -->
      <section class="p-4 md:p-6 rounded-2xl bg-white dark:bg-slate-800 shadow-sm">
        <h2 class="text-lg font-semibold mb-4">2) 空間の基本情報</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <label class="block"><span class="text-sm">プロジェクト種別</span>
            <select name="project" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
              <option>移転</option><option>改修</option><option selected>既存</option>
            </select>
          </label>
          <label class="block"><span class="text-sm">空間カテゴリー</span>
            <select name="category" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
              <option value="office">オフィス</option>
              <option value="nonoffice">オフィス以外（工場/学校/図書館/商業/スタジオ等）</option>
            </select>
          </label>
          <label class="block"><span class="text-sm">空間タイプ</span>
            <select name="spaceType" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
              <option value="meeting_closed">会議室（密閉）</option>
              <option value="meeting_transom">会議室（欄間オープン）</option>
              <option value="booth_tel">ワークブース（TELECUBE）</option>
              <option value="booth_built">ワークブース（造作）</option>
              <option value="open">オープンスペース（執務室）</option>
              <option value="reception">受付</option>
              <option value="callcenter">コールセンター</option>
              <option value="studio">スタジオ</option>
              <option value="other">その他</option>
            </select>
          </label>

          <!-- 利用用途（複数選択可） -->
          <div>
            <span class="text-sm block mb-1">利用用途（複数選択可）</span>
            <div class="grid grid-cols-1 gap-1">
              <label class="flex items-center gap-2"><input type="checkbox" name="use" value="meeting_multi" class="size-4">会議（複数人）</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="use" value="meeting_1to1" class="size-4">会議（1対1/少人数）</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="use" value="meeting_web" class="size-4">会議（Webメイン）</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="use" value="meeting_f2f" class="size-4">会議（対面メイン）</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="use" value="meeting_hybrid" class="size-4">会議（対面＋Web）</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="use" value="exec" class="size-4">役員会議</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="use" value="internal" class="size-4">社内会議</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="use" value="external" class="size-4">社外会議</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="use" value="focus" class="size-4">集中作業</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="use" value="phone" class="size-4">電話（個人/顧客）</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="use" value="websolo" class="size-4">Web会議（1人）</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="use" value="music" class="size-4">音楽鑑賞</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="use" value="stream" class="size-4">配信・収録</label>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
          <div>
            <span class="text-sm block mb-1">騒音源（複数選択可）</span>
            <label class="flex items-center gap-2"><input type="checkbox" name="source" value="speech" class="size-4">人の声</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="source" value="machine" class="size-4">機械音</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="source" value="invasion_ext" class="size-4">外部からの音の侵入</label>
          </div>
          <label class="block"><span class="text-sm">従業員の声（うるささ）</span>
            <select name="complaint" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
              <option value="low">低</option><option value="mid" selected>中</option><option value="high">高</option>
            </select>
          </label>
          <div>
            <span class="text-sm block mb-1">既存対策</span>
            <label class="flex items-center gap-2"><input type="checkbox" name="measure" value="partition" class="size-4">パーティション</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="measure" value="absorption" class="size-4">吸音パネル</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="measure" value="masking" class="size-4">サウンドマスキング</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="measure" value="none" class="size-4">特になし</label>
          </div>
        </div>
      </section>

      <!-- 3) 空間サイズ・構成要素 -->
      <section class="p-4 md:p-6 rounded-2xl bg-white dark:bg-slate-800 shadow-sm">
        <h2 class="text-lg font-semibold mb-4">空間サイズ・構成要素</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <label class="block"><span class="text-sm">床面積（㎡/室）</span>
            <input name="area" type="number" min="1" step="0.1" value="20" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent"/>
          </label>
          <label class="block"><span class="text-sm">室数（同仕様）</span>
            <input name="rooms" type="number" min="1" value="1" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent"/>
          </label>
          <label class="block"><span class="text-sm">天井高</span>
            <select name="ceilHeight" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
              <option value="lt2_5">2.5m未満</option>
              <option value="2_5_3_0" selected>2.5〜3.0m</option>
              <option value="3_0_3_5">3.0〜3.5m</option>
              <option value="gt3_5">3.5m以上</option>
              <option value="unknown">不明</option>
            </select>
          </label>
        </div>

        <!-- 壁材（4面） -->
        <div class="mt-4">
          <span class="text-sm block mb-2">壁材（4面）</span>
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <label class="block"><span class="text-xs text-slate-500">壁①</span>
              <select name="wall1" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
                <option value="gypsum">石膏ボード＋クロス</option>
                <option value="glass_s">ガラス（シングル）</option>
                <option value="glass_d">ガラス（ダブル）</option>
                <option value="rc">コンクリート打放し</option>
                <option value="abs_finish">吸音パネル仕上げ</option>
                <option value="wood">木質</option>
                <option value="steel_part">スチールパーティション</option>
                <option value="unknown">不明</option>
              </select>
            </label>
            <label class="block"><span class="text-xs text-slate-500">壁②</span>
              <select name="wall2" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
                <option value="gypsum">石膏ボード＋クロス</option>
                <option value="glass_s">ガラス（シングル）</option>
                <option value="glass_d">ガラス（ダブル）</option>
                <option value="rc">コンクリート打放し</option>
                <option value="abs_finish">吸音パネル仕上げ</option>
                <option value="wood">木質</option>
                <option value="steel_part">スチールパーティション</option>
                <option value="unknown">不明</option>
              </select>
            </label>
            <label class="block"><span class="text-xs text-slate-500">壁③</span>
              <select name="wall3" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
                <option value="gypsum">石膏ボード＋クロス</option>
                <option value="glass_s">ガラス（シングル）</option>
                <option value="glass_d">ガラス（ダブル）</option>
                <option value="rc">コンクリート打放し</option>
                <option value="abs_finish">吸音パネル仕上げ</option>
                <option value="wood">木質</option>
                <option value="steel_part">スチールパーティション</option>
                <option value="unknown">不明</option>
              </select>
            </label>
            <label class="block"><span class="text-xs text-slate-500">壁④</span>
              <select name="wall4" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
                <option value="gypsum">石膏ボード＋クロス</option>
                <option value="glass_s">ガラス（シングル）</option>
                <option value="glass_d">ガラス（ダブル）</option>
                <option value="rc">コンクリート打放し</option>
                <option value="abs_finish">吸音パネル仕上げ</option>
                <option value="wood">木質</option>
                <option value="steel_part">スチールパーティション</option>
                <option value="unknown">不明</option>
              </select>
            </label>
          </div>
        </div>

        <!-- 床・天井・扉・ガラス・その他 -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
          <label class="block"><span class="text-sm">床材</span>
            <select name="floor" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
              <option value="carpet">タイルカーペット</option>
              <option value="wood">フローリング</option>
              <option value="pvc">塩ビシート（PVC）</option>
              <option value="tile_stone">タイル・石材</option>
              <option value="unknown">不明</option>
            </select>
          </label>
          <label class="block"><span class="text-sm">天井材</span>
            <select name="ceiling" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
              <option value="pb">化粧石膏ボード</option>
              <option value="mineral_grid">岩綿吸音板（グリッド）</option>
              <option value="metal">金属パネル天井</option>
              <option value="exposed">露出天井（スケルトン）</option>
              <option value="unknown">不明</option>
            </select>
          </label>
          <label class="block"><span class="text-sm">扉の種類</span>
            <select name="door" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
              <option value="wood_solid">木製（単板）</option>
              <option value="wood_honeycomb">木製（中空ハニカム）</option>
              <option value="glass_s">ガラス（シングル）</option>
              <option value="glass_d">ガラス（ダブル）</option>
              <option value="steel">スチールドア</option>
              <option value="unknown">不明</option>
            </select>
          </label>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
          <label class="block"><span class="text-sm">扉の隙間処理</span>
            <select name="doorSeal" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
              <option value="gasket">ゴムパッキンあり（遮音）</option>
              <option value="bottom">ドアボトムシールあり</option>
              <option value="gap">隙間あり（標準）</option>
              <option value="unknown">不明</option>
            </select>
          </label>
          <label class="block"><span class="text-sm">ガラスの種類</span>
            <select name="glazing" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
              <option value="single">シングルガラス</option>
              <option value="double">ダブルガラス（ペア）</option>
              <option value="unknown">不明</option>
            </select>
          </label>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-4">
          <label class="flex items-center gap-2"><input type="checkbox" name="feature" value="transom" class="size-4">欄間オープン</label>
          <label class="flex items-center gap-2"><input type="checkbox" name="feature" value="shared_plenum" class="size-4">共有天井裏（隣室と連続）</label>
          <label class="flex items-center gap-2"><input type="checkbox" name="feature" value="grille" class="size-4">ガラリ／換気開口あり</label>
          <label class="flex items-center gap-2"><input type="checkbox" name="feature" value="gap_door_bottom" class="size-4">ドア下の隙間</label>
          <label class="flex items-center gap-2"><input type="checkbox" name="feature" value="gap_frame" class="size-4">枠まわりの隙間</label>
          <label class="flex items-center gap-2"><input type="checkbox" name="feature" value="gap_penetration" class="size-4">貫通部の隙間</label>
          <label class="flex items-center gap-2"><input type="checkbox" name="feature" value="gap_duct" class="size-4">ダクト等の隙間</label>
        </div>
      </section>

      <!-- 4) 期待効果・制約 -->
      <section class="md:col-span-2 p-4 md:p-6 rounded-2xl bg-white dark:bg-slate-800 shadow-sm">
        <h2 class="text-lg font-semibold mb-4">期待する効果・制約</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <span class="text-sm block mb-1">直接効果（複数選択可）</span>
            <label class="flex items-center gap-2"><input type="checkbox" name="effect" value="clarity_meeting" class="size-4">会議の聞き取り</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="effect" value="clarity_web" class="size-4">Web会議の聞き取り</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="effect" value="speaking" class="size-4">話しやすさ</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="effect" value="focus" class="size-4">集中力向上</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="effect" value="leakage" class="size-4">音漏れの低減</label>
          </div>
          <div>
            <span class="text-sm block mb-1">業務・体験効果</span>
            <label class="flex items-center gap-2"><input type="checkbox" name="effect" value="productivity" class="size-4">生産性アップ</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="effect" value="comfort" class="size-4">快適性・満足度</label>
          </div>
          <div>
            <span class="text-sm block mb-1">戦略的効果</span>
            <label class="flex items-center gap-2"><input type="checkbox" name="effect" value="brand" class="size-4">ブランド価値</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="effect" value="innov" class="size-4">先進的オフィスイメージ</label>
          </div>
        </div>

        <!-- 効果が未選択のときのエラー表示 -->
        <div id="effectsError" class="text-xs text-red-600 mt-2 hidden">
          「期待する効果」はどれか1つ以上選択してください。
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
          <label class="block"><span class="text-sm">改修許容（施工可否）</span>
            <select name="work" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
              <option value="night">夜間可</option><option value="weekend">週末のみ</option><option value="inhours">営業時間内のみ</option>
            </select>
          </label>
          <label class="block"><span class="text-sm">完全遮音（音漏れゼロ）希望</span>
            <select name="zeroLeak" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
              <option value="no">いいえ</option><option value="yes">はい</option>
            </select>
          </label>
          <label class="block"><span class="text-sm">自己評価：現状の音環境（0=悪い〜10=良い）</span>
            <input name="selfScore" type="number" min="0" max="10" value="5" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent"/>
          </label>
        </div>
      </section>

      <!-- 操作 -->
      <div class="md:col-span-2 flex flex-wrap gap-3 justify-end">
        <button type="button" id="resetBtn" class="px-4 py-2 rounded-xl border border-slate-300 dark:border-slate-700">リセット</button>
        <button type="button" id="diagnoseBtn" class="px-5 py-2.5 rounded-xl bg-emerald-600 text-white">診断する</button>
      </div>
    </form>

    <!-- ===== RESULT ===== -->
    <section id="result" class="mt-10 p-4 md:p-6 rounded-2xl bg-white dark:bg-slate-800 shadow-sm">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold">診断結果</h2>
        <div class="flex gap-2">
          <button id="downloadJson" class="px-3 py-2 rounded-xl border border-slate-300 dark:border-slate-700 text-sm">JSONダウンロード</button>
          <button id="printBtn" class="px-3 py-2 rounded-xl bg-slate-900 text-white text-sm dark:bg-slate-100 dark:text-slate-900">印刷 / PDF</button>
        </div>
      </div>

      <!-- 0) 提案サマリー -->
      <div id="proposalSummary" class="mt-4 w-full"></div>

      <!-- 1) エビデンス -->
      <div id="evidenceWrap" class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4"></div>

      <!-- 2) 詳細レコメンド -->
      <div id="recommendWrap" class="mt-6 grid grid-cols-1 lg:grid-cols-3 gap-4"></div>

      <!-- 3) iwasemi見積（詳細） -->
      <div id="iwasemiWrap" class="mt-6"></div>

      <!-- 4) 近い導入事例（※TELECUBE時は非表示） -->
      <div id="caseWrap" class="mt-6"></div>

      <!-- 5) TELECUBE 参考事例（TELECUBE時のみ表示） -->
      <div id="telecubeWrap" class="mt-6"></div>

      <!-- 6) 残響時間グラフ（注意・前提の直前に配置） -->
      <div id="rtChartWrap" class="mt-6 hidden">
        <div class="p-4 md:p-5 rounded-2xl border border-slate-200 dark:border-slate-700">
          <div class="text-base font-semibold mb-2">残響時間 比較（オクターブバンド）</div>
          <div class="text-xs text-slate-500 mb-3">
            現状と iwasemi 設置後（標準プラン）の推定残響時間を 500/1000/2000/4000/8000Hz で比較表示します。
          </div>
          <div id="rtContainer" class="relative" style="height:340px">
            <canvas id="rtChart" aria-label="残響時間グラフ" role="img"></canvas>
            <!-- 250Hzを半分隠すオーバレイ（幅はJSで算出） -->
            <div id="leftClip" class="left-clip-overlay"></div>
          </div>
        </div>
      </div>

      <!-- 備考 -->
      <div id="notesWrap" class="mt-6"></div>
    </section>

    <footer class="text-sm text-slate-500 dark:text-slate-400 mt-10">©Pixie Dust Technologies Inc.</footer>
  </div>

  <div id="toast" class="hidden"></div>

  <!-- Tips Overlay -->
  <div id="tipsOverlay" class="tips-overlay" role="dialog" aria-modal="true" aria-label="注意事項">
    <div class="tips-body">
      <div class="tips-card">
        <h3 class="text-xl font-semibold mb-2">開口部からの音の回り込みに注意</h3>
        <p class="text-sm opacity-90">
          欄間オープン／共有天井（プレナム共有）／ガラリ・換気開口は、隣室への<strong>音の回り込み経路</strong>になり、会話漏れ・プライバシー低下の主因となります。
          上部のインフィル（塞ぎ）、開口のライニング・ダクト化、ドア・枠まわりの隙間封止などの<strong>経路対策</strong>をご検討ください。
        </p>
        <ul class="list-disc pl-5 mt-2 text-sm opacity-90">
          <li>欄間：上部インフィル（遮音ボード＋シーリング）</li>
          <li>共有天井：プレナム内の連通部にバリア設置</li>
          <li>ガラリ：ライニング（吸音材）付きダクトやサウンドトラップ</li>
          <li>扉・枠：ガスケット、ドアボトムシールで隙間低減</li>
        </ul>
        <p id="tipsExtra" class="text-xs mt-2 opacity-80"></p>
        <div class="tips-actions">
          <button class="tips-btn gray" onclick="hideTips()">閉じる</button>
          <button class="tips-btn" onclick="hideTips()">了解</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ========== helpers ========== */
    const $ = (sel, el=document)=> el.querySelector(sel);
    const $$ = (sel, el=document)=> Array.from(el.querySelectorAll(sel));
    const enc = (s)=> encodeURIComponent(s||'');
    const yen = (n)=> '¥' + (Math.round(n)||0).toLocaleString('ja-JP');
    const fmt2 = (n)=> (Math.round((n??0)*100)/100).toFixed(2);

    // Theme
    const themeBtn = $('#themeToggle');
    function setTheme(mode){
      if(mode==='dark'){ document.documentElement.classList.add('dark'); localStorage.setItem('theme','dark'); themeBtn.textContent='ライト'; }
      else { document.documentElement.classList.remove('dark'); localStorage.setItem('theme','light'); themeBtn.textContent='ダーク'; }
    }
    themeBtn.addEventListener('click',()=> setTheme(document.documentElement.classList.contains('dark')?'light':'dark'));
    setTheme(localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light'));

    // Toast
    function toast(msg, ok=true){ const t=$('#toast'); t.className='toast '+(ok?'ok':'ng'); t.textContent=msg; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'),3200); }

    // Progress（効果グループも1ユニットとして加点）
    const formEl = $('#diagForm'); const progressBar = $('#progressBar');
    function updateProgress(){
      const req = $$('input[required], select[required]', formEl);
      const filled = req.filter(i => i.value && i.value.trim() !== '' && i.checkValidity());
      const effectChecked = $$("input[name='effect']:checked", formEl).length > 0;
      const total = req.length + 1; // +1 = 効果グループ
      const done  = filled.length + (effectChecked ? 1 : 0);
      const p = total ? Math.round((done/total)*100) : 100;
      progressBar.style.width = Math.min(100, Math.max(10, p)) + '%';
    }
    formEl.addEventListener('input', updateProgress); updateProgress();

    // Tips overlay
    function showTips(opts={}){ if(opts.transom){ $('#tipsExtra').innerHTML='欄間オープンの場合でも、壁面が硬質だと室内が反響しやすくなります。<strong>吸音</strong>で響きを抑えると回り込み軽減に寄与する場合があります。'; } else { $('#tipsExtra').textContent=''; } $('#tipsOverlay').style.display='block'; }
    function hideTips(){ $('#tipsOverlay').style.display='none'; }

    // Collect
    function getAllChecked(name){ return $$("input[name='"+name+"']:checked").map(i=>i.value); }
    function collect(){
      const fd = new FormData(formEl);
      return {
        // 顧客
        company: fd.get('company')||'', person: fd.get('person')||'', email: fd.get('email')||'',
        industry: fd.get('industry')||'', size: fd.get('size')||'', pref: fd.get('pref')||'', timeline: fd.get('timeline')||'未定',
        // 代理店
        agentCompany: fd.get('agentCompany')||'', agentPerson: fd.get('agentPerson')||'', agentBranch: fd.get('agentBranch')||'', agentEmail: fd.get('agentEmail')||'',
        // 空間
        project: fd.get('project')||'既存', category: fd.get('category')||'office', spaceType: fd.get('spaceType')||'meeting_closed',
        uses: getAllChecked('use'), sources: getAllChecked('source'), complaint: fd.get('complaint')||'mid', measures: getAllChecked('measure'),
        // 構成
        area: Number(fd.get('area')||0), rooms: Number(fd.get('rooms')||1), ceilHeight: fd.get('ceilHeight')||'2_5_3_0',
        walls: [fd.get('wall1')||'gypsum', fd.get('wall2')||'gypsum', fd.get('wall3')||'gypsum', fd.get('wall4')||'gypsum'],
        floor: fd.get('floor')||'carpet', ceiling: fd.get('ceiling')||'pb', door: fd.get('door')||'wood_solid', doorSeal: fd.get('doorSeal')||'gasket',
        glazing: fd.get('glazing')||'single', features: getAllChecked('feature'),
        // 効果・制約
        effects: getAllChecked('effect'), work: fd.get('work')||'night', zeroLeak: fd.get('zeroLeak')==='yes', selfScore: Number(fd.get('selfScore')||5)
      };
    }

    // ===== バリデーション（必須条件） =====
    function setInvalid(el, on){
      if(!el) return;
      el.classList.toggle('border-red-500', !!on);
      el.setAttribute('aria-invalid', on ? 'true' : 'false');
    }
    function validateRequiredFields(){
      const missing = [];

      // 1-B) 代理店（全て必須）
      const agentNames = ['agentCompany','agentPerson','agentBranch','agentEmail'];
      agentNames.forEach(name => {
        const el = formEl.elements[name];
        setInvalid(el, false);
        if(!el || !el.value || !el.checkValidity()){
          setInvalid(el, true);
          missing.push(el);
        }
      });

      // 4) 効果：どれか1つ以上
      const effectChecked = $$("input[name='effect']:checked", formEl).length > 0;
      const effectsError = $('#effectsError');
      if(!effectChecked){
        effectsError?.classList.remove('hidden');
        missing.push($$("input[name='effect']")[0] || effectsError);
      }else{
        effectsError?.classList.add('hidden');
      }

      if(missing.length){
        const first = missing[0];
        try{ first.scrollIntoView({behavior:'smooth', block:'center'}); }catch(_){}
        try{ first.focus({preventScroll:true}); }catch(_){}
        toast('必須項目を入力してください（代理店情報と「期待する効果」）', false);
        return false;
      }
      return true;
    }

    /* ========== acoustics ========== */
    const alpha = {
      gypsum:{a500:0.06,a1000:0.06}, rc:{a500:0.02,a1000:0.02},
      glass_s:{a500:0.15,a1000:0.10}, glass_d:{a500:0.12,a1000:0.10},
      abs_finish:{a500:0.30,a1000:0.30}, wood:{a500:0.10,a1000:0.08},
      steel_part:{a500:0.07,a1000:0.06}, unknown:{a500:0.06,a1000:0.06},
      carpet:{a500:0.21,a1000:0.26}, wood_f:{a500:0.10,a1000:0.08}, pvc:{a500:0.02,a1000:0.02}, tile_stone:{a500:0.02,a1000:0.02}, floor_unknown:{a500:0.10,a1000:0.08},
      pb:{a500:0.10,a1000:0.08}, mineral_grid:{a500:0.45,a1000:0.55}, metal:{a500:0.10,a1000:0.10}, exposed:{a500:0.05,a1000:0.05}, ceil_unknown:{a500:0.10,a1000:0.08}
    };
    const getAlphaWall = (k)=> alpha[k]||alpha.gypsum;
    const getAlphaFloor = (k)=> ({carpet:alpha.carpet, wood:alpha.wood_f, pvc:alpha.pvc, tile_stone:alpha.tile_stone}[k]||alpha.floor_unknown);
    const getAlphaCeil = (k)=> alpha[k]||alpha.ceil_unknown;

    function heightFromKey(k){ if(k==='lt2_5')return 2.4; if(k==='2_5_3_0')return 2.75; if(k==='3_0_3_5')return 3.25; if(k==='gt3_5')return 3.8; return 2.7; }
    function rtTarget(spaceType, uses){
      let t=0.6;
      if(spaceType==='booth_tel'||spaceType==='booth_built') t=0.35;
      else if(spaceType==='open'||spaceType==='callcenter') t=0.7;
      else if(spaceType==='studio') t=0.3;
      if(uses.includes('stream')) t*=0.85;
      if(uses.includes('music')) t*=0.9;
      return t;
    }

    function calcRT(d){
      const A = Math.max(0.1, d.area); const H = heightFromKey(d.ceilHeight); const V = A*H;
      const s = Math.sqrt(A); const wallAreas=[s*H,s*H,s*H,s*H]; const floorArea=A; const ceilArea=A;
      const aw = d.walls.map(getAlphaWall), af=getAlphaFloor(d.floor), ac=getAlphaCeil(d.ceiling);
      const walls500 = aw[0].a500*wallAreas[0] + aw[1].a500*wallAreas[1] + aw[2].a500*wallAreas[2] + aw[3].a500*wallAreas[3];
      const walls1000= aw[0].a1000*wallAreas[0]+ aw[1].a1000*wallAreas[1]+ aw[2].a1000*wallAreas[2]+ aw[3].a1000*wallAreas[3];
      const floor500=af.a500*floorArea, floor1000=af.a1000*floorArea;
      const CEIL_EFF=0.60;
      const Aceil500=ac.a500*ceilArea*CEIL_EFF, Aceil1000=ac.a1000*ceilArea*CEIL_EFF;
      const Aflat500=walls500+floor500, Aflat1000=walls1000+floor1000;
      const cap=0.45;
      const Aeq500 = Math.min(Aflat500/(1-cap), Aflat500 + Aceil500);
      const Aeq1000= Math.min(Aflat1000/(1-cap), Aflat1000+ Aceil1000);
      const T500 = 0.161 * V / Math.max(0.001, Aeq500);
      const T1000= 0.161 * V / Math.max(0.001, Aeq1000);

      // グラフ用：6帯域の簡易Aeq/T（500/1000からの推定）
      const freqs=[250,500,1000,2000,4000,8000];
      const Aeq_values=freqs.map(f=>{
        if(f===500) return Aeq500;
        if(f===1000) return Aeq1000;
        const r=f<500 ? 0.6 : f<1000 ? (f-500)/500 : f<2000 ? 0.6+(f-1000)/2000 : 0.85+(f-2000)/6000;
        return Aeq500*(1-r)+Aeq1000*r;
      });
      const T_values=Aeq_values.map(Aeq=>0.161*V/Math.max(0.001,Aeq));
      return { V,A,H,s,wallAreas,floorArea,ceilArea,Aeq500,Aeq1000,T500,T1000, Aeq_values, T_values };
    }

    // Scores
    function scoreAbs(d, rt){
      if (d.spaceType==='booth_tel') return null;
      const Ttgt = rtTarget(d.spaceType, d.uses);
      const Tavg = (rt.T500 + rt.T1000)/2;
      const r = Math.max(1, Tavg / Ttgt);
      const RCAP=1.9;
      let s = Math.round(100 * Math.min(1, Math.log(r)/Math.log(RCAP)));
      const U = new Set(d.uses);
      if (U.has('meeting_web') || U.has('meeting_hybrid') || U.has('websolo')) s += 3;
      if (d.ceiling==='mineral_grid') s = Math.max(8,s);
      return Math.max(0, Math.min(100, s));
    }
    function isolationIndicators(d){
      const indicators={
        extInvasion: d.sources.includes('invasion_ext')?1:0,
        transom: d.features.includes('transom')?1:0,
        plenum: d.features.includes('shared_plenum')?1:0,
        grille: d.features.includes('grille')?1:0,
        gaps: ['gap_door_bottom','gap_frame','gap_penetration','gap_duct'].some(k=>d.features.includes(k))?1:0
      };
      const any = Object.values(indicators).some(v=>v===1);
      return {indicators, any};
    }
    function wallStatsForIsl(walls){ const cnt=t=>walls.filter(w=>t.includes(w)).length; return {glassCount:cnt(['glass_s','glass_d']), rcCount:cnt(['rc'])}; }
    function scoreIsl(d, rt){
      if (d.spaceType==='booth_tel') return null;
      let s=0; const {indicators, any}=isolationIndicators(d); const ws=wallStatsForIsl(d.walls);
      if (indicators.transom) s+=28; if (indicators.plenum) s+=28; if (indicators.grille) s+=22; if (indicators.gaps) s+=12;
      if (indicators.extInvasion) s+=24;
      if (d.door==='wood_honeycomb') s+=12; if (d.door==='glass_s'||d.door==='glass_d') s+=10; if (d.door==='steel') s-=8;
      if (d.doorSeal==='gap') s+=10; if (d.doorSeal==='gasket') s-=5;
      if (d.glazing==='single') s+=8; if (d.glazing==='double') s-=6;
      if (ws.glassCount>=2) s+=8; else if (ws.glassCount===1) s+=5; if (ws.rcCount>=2) s-=8;
      if (['exec','external'].some(u=>d.uses.includes(u))) s+= any?6:3;
      if (!any) s = Math.min(s,35);
      const Ttgt=rtTarget(d.spaceType,d.uses), Tavg=(rt.T500+rt.T1000)/2, ratio=Tavg/Ttgt;
      if (ratio>=1.5 && s<40) s*=0.6; else if (ratio>=1.3 && s<50) s*=0.7;
      return Math.max(0, Math.round(s));
    }

    /* ========== iwasemi 枚数（表ベース補間） ========== */
    const PANEL_ANCHORS=[
      {a:5,p:50},{a:10,p:100},{a:15,p:150},{a:20,p:190},{a:25,p:230},{a:30,p:270},
      {a:40,p:350},{a:50,p:430},{a:60,p:500},{a:80,p:640},{a:100,p:770}
    ];
    function interpPanels(area){
      if (area<=PANEL_ANCHORS[0].a) return PANEL_ANCHORS[0].p;
      for (let i=1;i<PANEL_ANCHORS.length;i++){ const lo=PANEL_ANCHORS[i-1], hi=PANEL_ANCHORS[i];
        if (area<=hi.a){ const t=(area-lo.a)/(hi.a-lo.a); return Math.round(lo.p + t*(hi.p-lo.p)); } }
      const last=PANEL_ANCHORS[PANEL_ANCHORS.length-1], prev=PANEL_ANCHORS[PANEL_ANCHORS.length-2];
      const slope=(last.p-prev.p)/(last.a-prev.a); return Math.round(last.p + (area-last.a)*slope);
    }
    const UNIT_PRICE=5000;
    function buildPanelSolutions(d, primaryKey, rt){
      const perRoomStd=Math.max(1, interpPanels(d.area)); const totalStd=perRoomStd*Math.max(1,Math.round(d.rooms)); const totalPro=Math.max(totalStd+1, Math.round(totalStd*1.2));
      function bomFor(panels, withSeal){
        const parts=[]; const pricePanels=panels*UNIT_PRICE; parts.push({name:'iwasemi パネル（代表）', qty:panels, price:pricePanels});
        let extras=0;
        if (withSeal){ const rooms=Math.max(1,Math.round(d.rooms)); const seal=15000*rooms;
          parts.push({name:'隙間封止（参考費用・別途手配）', qty:rooms, price:seal}); extras+=seal; }
        const install=Math.round(pricePanels*0.20); parts.push({name:'仮設・夜間施工（概算）', qty:1, price:install});
        const subtotal=pricePanels+extras+install; return {bom:parts, subtotal};
      }
      const needSeal=(primaryKey==='abs_plus_seal' || primaryKey==='isolation');
      const std=bomFor(totalStd, needSeal), pro=bomFor(totalPro, needSeal);
      return { perRoomStd,totalStd,totalPro, Ttgt: rtTarget(d.spaceType,d.uses),
        plans:[{name:'標準', panels:totalStd, bom:std.bom, subtotal:std.subtotal},{name:'強め', panels:totalPro, bom:pro.bom, subtotal:pro.subtotal}] };
    }

    /* ========== Recommend（文章） ========== */
    function recommend(d, S, rt){
      const list=[]; const ratio=((rt.T500+rt.T1000)/2)/rtTarget(d.spaceType,d.uses); const {any}=isolationIndicators(d);
      const TEXT={
        booth_abs:'ブース内で残響（音の響き）が強く声がこもりやすいため、ガラスや金属面に小型吸音パネルを分散配置することが効果的です。',
        abs_high:'残響（音の響き）が目標値を上回っており、会話の明瞭度や聞き取りやすさの改善には壁や天井への吸音パネル設置が有効です。',
        abs_mid:'残響（音の響き）がやや強いため、一部エリアから吸音パネルを段階的に導入して響きを整えることが効果的です。',
        measure:'残響（音の響き）はおおむね良好ですが、導入前に響きの測定や体感トライアルで最適な吸音量を確認することが有効です。',
        abs_seal:'声が隣に漏れやすく、室内の残響（音の響き）も強いため、すき間をふさぎつつ吸音で音漏れを軽減することが効果的です。',
        isolation:'残響（音の響き）に加え、欄間や天井、ドアまわりから音が伝わりやすいため、仕切り設置や遮音対策を行うことが有効です。'
      };

      if (S.S_abs===null && S.S_isl===null){ // TELECUBE
        list.push({key:'absorption',label:'吸音（ブース内面）',priority:'高',score:50,reason:TEXT.booth_abs});
        return list;
      }

      if (S.S_abs<12 && S.S_isl<40){
        list.push({key:'measure',label:'計測／トライアル',priority:'高',score:50,reason:TEXT.measure}); return list;
      }

      if (S.S_isl>=60 || (d.zeroLeak && any)){
        list.push({key:'isolation',label:'遮音',priority:'高',score:S.S_isl,reason:TEXT.isolation});
      } else if (S.S_isl>=45){
        list.push({key:'abs_plus_seal',label:'吸音＋隙間対策',priority:'高',score:S.S_isl + Math.min(12,0.25*(S.S_abs||0)),reason:TEXT.abs_seal});
      } else if (ratio>=1.3 && (S.S_abs||0)>=12){
        list.push({key:'absorption',label:'吸音',priority:'高',score:S.S_abs,reason:TEXT.abs_high});
      } else {
        list.push({key:'measure',label:'計測／トライアル',priority:'高',score:50,reason:TEXT.measure});
      }

      const hasAbs=list.some(x=>x.key==='absorption'||x.key==='abs_plus_seal');
      if (!hasAbs && (S.S_abs||0)>=12){
        list.push({key:'absorption',label:'吸音',priority:'中',score:Math.max(30,S.S_abs),reason:TEXT.abs_mid});
      }
      if (!list.some(x=>x.key==='isolation') && (S.S_isl||0)>=40){
        list.push({key:'abs_plus_seal',label:'吸音＋隙間対策',priority:'低',score:S.S_isl,reason:TEXT.abs_seal});
      }
      return list.slice(0,3).sort((a,b)=>b.score-a.score);
    }

    /* ========== Render ========== */
    function clearResult(){
      $('#proposalSummary').innerHTML=''; $('#evidenceWrap').innerHTML='';
      $('#recommendWrap').innerHTML=''; $('#iwasemiWrap').innerHTML='';
      $('#caseWrap').innerHTML=''; $('#telecubeWrap').innerHTML=''; $('#notesWrap').innerHTML='';
      $('#rtChartWrap').classList.add('hidden');
    }
    function cardExplainAbs(s){ if(s>=70)return'吸音材の導入が強く推奨されます（高残響）。'; if(s>=40)return'吸音導入で明瞭度の改善が期待できます。'; if(s>=12)return'軽微な吸音でも改善が見込めます。'; return'現状、吸音の必要性は小さいと推定されます。'; }
    function cardExplainIsl(s){ if(s>=60)return'遮音工事が主目的（欄間・共有天井・隙間等の経路対策）。'; if(s>=45)return'隙間封止等の簡易遮音と吸音の併用が有効です。'; if(s>=30)return'軽微な回り込み対策を検討してください。'; return'現状、遮音（漏れ/侵入）の優先度は高くありません。'; }
    function evidenceLines(d,S,rt){
      const Ttgt=rtTarget(d.spaceType,d.uses); const Tavg=(rt.T500+rt.T1000)/2; const ratio=Tavg/Ttgt;
      const feats=[]; if(d.features.includes('transom'))feats.push('欄間オープン'); if(d.features.includes('shared_plenum'))feats.push('共有天井裏'); if(d.features.includes('grille'))feats.push('ガラリ/換気開口');
      if(['gap_door_bottom','gap_frame','gap_penetration','gap_duct'].some(x=>d.features.includes(x)))feats.push('隙間あり'); if(d.sources.includes('invasion_ext'))feats.push('外部からの音の侵入');
      return {
        line1:`残響：平均 ${fmt2(Tavg)}s / 目標 ${fmt2(Ttgt)}s（比 ${fmt2(ratio)}）`,
        line2:`吸音必要度 ${(S.S_abs??'—')} / 遮音必要度 ${(S.S_isl??'—')}（スケール：0〜100）`,
        line3:`回り込みの要因：${feats.length?feats.join('・'):'特になし'}`,
        explainRT: ratio>=1.3 ? '目標より残響が長いため、吸音導入で明瞭度の改善が見込めます。' : ratio<=0.9 ? '残響は良好な範囲です。吸音は補助的で十分な可能性があります。' : '残響はほぼ目標範囲です。用途により軽微な吸音で調整可能です。',
        explainLeak: (S.S_isl??0)>=45 ? '欄間・共有天井や隙間等の回り込みが疑われます。隙間封止/遮音対策を検討ください。' : (S.S_isl??0)>=30 ? '軽微な回り込みの可能性があります。簡易対策で改善余地。' : '明確な回り込み要素は小さめです。'
      };
    }

    function renderProposalSummary(d, recs, S, rt, panelSol){
      const top = recs[0];
      const std=panelSol.plans.find(p=>p.name==='標準');
      const pro=panelSol.plans.find(p=>p.name==='強め');

      let priceLine = `<span class="badge bg-white/60 dark:bg-slate-800/60">別途見積</span>`;
      if (['吸音','吸音＋隙間対策','吸音（ブース内面）'].includes(top.label) || ['absorption','abs_plus_seal'].includes(top.key)){
        priceLine = `<span class="tabular-nums font-semibold">${yen(std.subtotal)}〜${yen(pro.subtotal)}</span> <span class="text-xs text-slate-500">（概算・税抜）</span>`;
      }

      const CTA = `
        <div class="mt-3 grid grid-cols-1 md:grid-cols-3 gap-3">
                    <a class="w-full px-4 py-2 rounded-xl bg-emerald-600 text-white text-center" id="ctaQuote">詳細見積を依頼</a>
          <a class="w-full px-4 py-2 rounded-xl border border-slate-300 dark:border-slate-700 text-center" id="ctaShare">担当に共有（メール）</a>
          <a class="w-full px-4 py-2 rounded-xl bg-slate-900 text-white text-center dark:bg-slate-100 dark:text-slate-900" id="ctaPDF">PDF保存</a>
        </div>`;
      const wrap = $('#proposalSummary');
      wrap.innerHTML = `
        <div class="p-4 md:p-5 rounded-2xl border border-slate-200 dark:border-slate-700">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
            <div>
              <div class="text-sm text-slate-500 dark:text-slate-400">優先施策</div>
              <div class="text-xl font-bold mt-0.5">${top.label}</div>
              <div class="text-sm mt-1">${top.reason}</div>
            </div>
            <div class="text-right">
              <div class="text-sm text-slate-500 dark:text-slate-400">概算レンジ</div>
              <div class="text-lg">${priceLine}</div>
              <div class="text-xs text-slate-500 mt-1">前提：${d.rooms}室 / ${fmt2(d.area)}㎡/室</div>
            </div>
          </div>
          ${CTA}
        </div>
      `;

      // CTA actions
      const mailto = ()=>{
        const subj = `iwasemi 診断結果：${d.company||'無題'}`;
        const lines = [
          '以下の診断結果を共有します。',
          `優先施策：${top.label}`,
          `概算：${['吸音','吸音＋隙間対策','吸音（ブース内面）'].includes(top.label)? (yen(std.subtotal)+'〜'+yen(pro.subtotal)) : '別途見積'}`,
          `面積：${fmt2(d.area)}㎡/室 × ${d.rooms}室`,
          `連絡先：${d.agentCompany} ${d.agentPerson}`
        ];
        const body = lines.join('\n');
        location.href = `mailto:${enc(d.agentEmail||d.email||'')}`+
                        `?subject=${enc(subj)}&body=${enc(body)}`;
      };
      wrap.querySelector('#ctaShare')?.addEventListener('click', e=>{ e.preventDefault(); mailto(); });
      wrap.querySelector('#ctaPDF')?.addEventListener('click', e=>{ e.preventDefault(); window.print(); });
      wrap.querySelector('#ctaQuote')?.addEventListener('click', e=>{
        e.preventDefault();
        toast('見積依頼の準備を開始しました。担当にメールで共有してください。', true);
        mailto();
      });
    }

    function renderEvidence(d, S, rt){
      const e = evidenceLines(d,S,rt);
      $('#evidenceWrap').innerHTML = `
        <div class="p-4 rounded-2xl border border-slate-200 dark:border-slate-700">
          <div class="text-sm font-semibold mb-2">残響の状況</div>
          <div class="text-sm">${e.line1}</div>
          <div class="text-xs text-slate-500 mt-1">${e.explainRT}</div>
        </div>
        <div class="p-4 rounded-2xl border border-slate-200 dark:border-slate-700">
          <div class="text-sm font-semibold mb-2">遮音・回り込み</div>
          <div class="text-sm">${e.line2}</div>
          <div class="text-xs text-slate-500 mt-1">${e.explainLeak}</div>
        </div>
        <div class="p-4 rounded-2xl border border-slate-200 dark:border-slate-700">
          <div class="text-sm font-semibold mb-2">前提条件</div>
          <ul class="text-sm list-disc pl-5 space-y-0.5">
            <li>用途：${(d.uses||[]).length? d.uses.join('、') : '—'}</li>
            <li>構成：壁=${d.walls.join(' / ')} / 天井=${d.ceiling} / 床=${d.floor}</li>
            <li>特徴：${(d.features||[]).length? d.features.join('、') : '—'}</li>
          </ul>
        </div>
      `;
    }

    function renderRecommend(recs, S){
      const html = recs.map(r=>{
        const note = r.key==='absorption' ? cardExplainAbs(S.S_abs||0)
                  : r.key==='isolation' ? cardExplainIsl(S.S_isl||0)
                  : '測定やトライアルにより最小限の投資で最適点を見極めます。';
        return `
        <div class="p-4 rounded-2xl border border-slate-200 dark:border-slate-700">
          <div class="flex items-center justify-between">
            <div class="text-base font-semibold">${r.label}</div>
            <span class="badge">${r.priority}</span>
          </div>
          <div class="text-sm mt-1">${r.reason}</div>
          <div class="text-xs text-slate-500 mt-1">${note}</div>
        </div>`;
      }).join('');
      $('#recommendWrap').innerHTML = html;
    }

    function bomTable(plan){
      const rows = plan.bom.map(it=>`
        <tr>
          <td class="py-1 pr-2">${it.name}</td>
          <td class="py-1 pr-2 text-right tabular-nums">${it.qty}</td>
          <td class="py-1 text-right tabular-nums">${yen(it.price)}</td>
        </tr>
      `).join('');
      return `
      <div class="p-4 rounded-2xl border border-slate-200 dark:border-slate-700">
        <div class="font-semibold mb-2">${plan.name} プラン</div>
        <div class="text-sm text-slate-500 mb-2">想定パネル枚数：${plan.panels}枚（全体）</div>
        <table class="w-full text-sm">
          <thead class="text-slate-500 text-xs">
            <tr><th class="text-left font-normal">項目</th><th class="text-right font-normal">数量</th><th class="text-right font-normal">金額</th></tr>
          </thead>
          <tbody>${rows}</tbody>
          <tfoot>
            <tr><td colspan="3"><div class="border-t border-slate-200 dark:border-slate-700 my-2"></div></td></tr>
            <tr><td class="text-right text-slate-500 text-xs" colspan="2">小計（税抜）</td><td class="text-right font-semibold">${yen(plan.subtotal)}</td></tr>
          </tfoot>
        </table>
      </div>`;
    }

    function renderIwasemi(d, topRec, panelSol){
      const wrap = $('#iwasemiWrap');
      if (['absorption','abs_plus_seal','booth_abs'].includes(topRec.key)){
        const std = panelSol.plans.find(p=>p.name==='標準');
        const pro = panelSol.plans.find(p=>p.name==='強め');
        wrap.innerHTML = `
          <div class="p-4 md:p-5 rounded-2xl border border-slate-200 dark:border-slate-700">
            <div class="text-base font-semibold mb-1">iwasemi 設置概算（${panelSol.perRoomStd}枚/室 目安）</div>
            <div class="text-xs text-slate-500 mb-3">※工事環境により金額は増減します。現地確認の上、正式見積いたします。</div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              ${bomTable(std)}
              ${bomTable(pro)}
            </div>
          </div>
        `;
      } else if (topRec.key==='isolation'){
        wrap.innerHTML = `
          <div class="p-4 md:p-5 rounded-2xl border border-slate-200 dark:border-slate-700">
            <div class="text-base font-semibold mb-1">遮音工事について</div>
            <div class="text-sm">欄間・共有天井・開口・隙間等の<strong>経路遮断</strong>が主目的となります。現地踏査後に別途お見積りいたします。</div>
          </div>`;
      } else {
        wrap.innerHTML = '';
      }
    }

    function renderCases(d){
      // TELECUBE のときは通常事例を非表示
      const caseWrap = $('#caseWrap');
      if (d.spaceType==='booth_tel'){ caseWrap.innerHTML=''; return; }

      const cases = [
        {title:'会議室（6名・ガラス2面）', body:'壁面の一部に吸音（約220枚/室相当）。明瞭度が改善し、Web会議の反響苦情が解消。', tag:'吸音'},
        {title:'オープンスペース（集中席）', body:'天井吸音＋背面吸音で打鍵音の反響を抑制。会話の抜けを残しつつSPL低減。', tag:'快適性'},
      ];
      caseWrap.innerHTML = `
        <div class="p-4 md:p-5 rounded-2xl border border-slate-200 dark:border-slate-700">
          <div class="text-base font-semibold mb-3">近い導入事例</div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            ${cases.map(c=>`
              <div class="rounded-2xl border border-slate-200 dark:border-slate-700 p-4">
                <div class="text-sm font-semibold flex items-center justify-between">
                  ${c.title}<span class="badge">${c.tag}</span>
                </div>
                <div class="text-sm mt-1">${c.body}</div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    function renderTelecube(d){
      const tw = $('#telecubeWrap');
      if (d.spaceType!=='booth_tel'){ tw.innerHTML=''; return; }
      tw.innerHTML = `
        <div class="p-4 md:p-5 rounded-2xl border border-slate-200 dark:border-slate-700">
          <div class="text-base font-semibold mb-3">TELECUBE 参考</div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <img class="telecube-img" alt="ワークブース内のレイアウト例" src="https://images.unsplash.com/photo-1616587894289-86480e533129?q=80&w=1200&auto=format&fit=crop"/>
              <div class="text-xs text-slate-500 mt-2">※代表イメージ。ブース内での反射面（ガラス・金属）に小型吸音を分散配置。</div>
            </div>
            <div class="text-sm">
              <div class="font-semibold mb-1">推奨ポイント</div>
              <ul class="list-disc pl-5 space-y-1">
                <li>話者の顔まわり（前方・側方）の一次反射に吸音を配置。</li>
                <li>机面やガラスの<strong>相互反射</strong>を避け、分散配置でこもりを軽減。</li>
                <li>Web会議主体の場合はマイク周りの初期反射を重点抑制。</li>
              </ul>
            </div>
          </div>
        </div>
      `;
    }

    // ---- 残響グラフ描画 ----
    let rtChart=null;
    function renderRTChart(d, rt, panelSol){
      const wrap = $('#rtChartWrap');
      wrap.classList.remove('hidden');

      // 追加吸音（1枚あたりの等価吸音面積の簡易仮定）
      const AeqPerPanel = 0.35; // m² sabin eq.（500〜2000Hzの代表）
      const addAeq = Math.max(0, panelSol.perRoomStd) * AeqPerPanel;

      const freqs=[250,500,1000,2000,4000,8000];
      const Tnow = rt.T_values;
      const Aeq_after = rt.Aeq_values.map((A,i)=>{
        // 帯域によって寄与率を少し変える（高域やや少なめ）
        const k = (freqs[i]===250)?0.7 : (freqs[i]===8000?0.6:0.9);
        return A + addAeq*k;
      });
      const Tafter = Aeq_after.map(A=> 0.161*rt.V/Math.max(0.001,A));

      const ctx = $('#rtChart').getContext('2d');
      if (rtChart){ rtChart.destroy(); }

      rtChart = new Chart(ctx, {
        type:'line',
        data:{
          labels: freqs.map(f=>f+'Hz'),
          datasets:[
            {label:'現状', data:Tnow, borderWidth:2, tension:0.25, pointRadius:2},
            {label:'iwasemi標準後', data:Tafter, borderWidth:2, tension:0.25, pointRadius:2}
          ]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          scales:{
            y:{ title:{display:true, text:'残響時間 [s]'}, beginAtZero:true },
            x:{ title:{display:false, text:''} }
          },
          plugins:{
            legend:{ position:'bottom' },
            tooltip:{ mode:'index', intersect:false }
          }
        }
      });

      // 250Hz を半分隠す左オーバレイの幅を算出
      setTimeout(()=>{
        try{
          const meta = rtChart.getDatasetMeta(0);
          const bar0 = meta.data?.[0];
          const ca = rtChart.chartArea;
          const leftClip = $('#leftClip');
          if(bar0 && ca){
            const w = Math.max(0, (bar0.x - (bar0.width?bar0.width/2: (bar0._model?.width||20)/2)));
            leftClip.style.width = `${w}px`;
            // 背景色は親パネルの背景に合わせる
            let p = $('#rtChart'); let bg='rgba(255,255,255,1)';
            while (p && p !== document.body){
              const c = getComputedStyle(p).backgroundColor;
              if(c && c!=='rgba(0, 0, 0, 0)'){ bg=c; break; }
              p = p.parentElement;
            }
            leftClip.style.background = bg;
          }
        }catch(_){}
      }, 60);
    }

    function renderNotes(d){
      $('#notesWrap').innerHTML = `
        <div class="p-4 md:p-5 rounded-2xl border border-slate-200 dark:border-slate-700">
          <div class="text-base font-semibold mb-1">注意・前提</div>
          <ul class="text-sm list-disc pl-5 space-y-1">
            <li>本診断は入力情報からの<strong>簡易推定</strong>です。現地踏査・実測により最終提案を確定します。</li>
            <li>欄間オープン・共有天井・ガラリ・隙間は<strong>回り込み経路</strong>となるため、吸音と併せて遮音対策が必要な場合があります。</li>
            <li>価格は概算（税抜）。仮設条件・夜間対応・搬入条件等で増減します。</li>
          </ul>
        </div>
      `;
    }

    /* ===== JSON DL / PRINT ===== */
    let diagCache = null;
    function buildExport(d, rt, S, recs, panelSol){
      return {
        meta:{ generatedAt:new Date().toISOString(), version:'1.0.0' },
        input:d,
        acoustics:{
          volume:rt.V, height:rt.H, area:d.area,
          targets:{rtTarget:rtTarget(d.spaceType,d.uses)},
          T_now:{'250':rt.T_values[0],'500':rt.T_values[1],'1000':rt.T_values[2],'2000':rt.T_values[3],'4000':rt.T_values[4],'8000':rt.T_values[5]},
          Aeq_now:{'250':rt.Aeq_values[0],'500':rt.Aeq_values[1],'1000':rt.Aeq_values[2],'2000':rt.Aeq_values[3],'4000':rt.Aeq_values[4],'8000':rt.Aeq_values[5]}
        },
        scores:{ absorption:S.S_abs, isolation:S.S_isl },
        recommend: recs,
        iwasemi: panelSol
      };
    }

    $('#downloadJson').addEventListener('click', ()=>{
      if(!diagCache){ toast('先に「診断する」を実行してください', false); return; }
      const blob = new Blob([JSON.stringify(diagCache, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `iwasemi_diag_${Date.now()}.json`;
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 1000);
    });

    $('#printBtn').addEventListener('click', ()=> window.print());

    /* ====== メイン：診断実行 ====== */
    function runDiagnose(){
      if(!validateRequiredFields()) return;
      const d = collect();
      const rt = calcRT(d);
      const S = { S_abs: scoreAbs(d, rt), S_isl: scoreIsl(d, rt) };
      const recs = recommend(d, S, rt);
      const top = recs[0] || {key:'measure', label:'計測／トライアル'};
      const panelSol = buildPanelSolutions(d, top.key, rt);

      // Render
      clearResult();
      renderProposalSummary(d, recs, S, rt, panelSol);
      renderEvidence(d, S, rt);
      renderRecommend(recs, S);
      renderIwasemi(d, top, panelSol);
      renderCases(d);
      renderTelecube(d);
      renderRTChart(d, rt, panelSol);
      renderNotes(d);

      // Tips
      const {indicators, any} = isolationIndicators(d);
      if(any){ showTips({transom: indicators.transom}); }

      // Export cache
      diagCache = buildExport(d, rt, S, recs, panelSol);

      // Scroll
      try{ $('#result').scrollIntoView({behavior:'smooth', block:'start'}); }catch(_){}
      toast('診断結果を生成しました');
    }

    $('#diagnoseBtn').addEventListener('click', runDiagnose);

    $('#resetBtn').addEventListener('click', ()=>{
      formEl.reset();
      updateProgress();
      clearResult();
      toast('入力をリセットしました');
    });

    // 初期
    updateProgress();
  </script>
</body>
</html>


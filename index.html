<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>iwasemi｜音問題 診断サービス（フォーム連携＋事例連携）</title>

  <!-- Noto Sans JP -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['"Noto Sans JP"','"Noto Sans"','ui-sans-serif','system-ui','-apple-system','"Hiragino Kaku Gothic ProN"','Meiryo','sans-serif']
          }
        }
      }
    }
  </script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{ color-scheme: light dark; }
    .badge{display:inline-block;padding:.125rem .5rem;border-radius:.5rem;font-size:.75rem;border:1px solid rgba(16,185,129,.35)}
    .toast{position:fixed;right:1rem;bottom:1rem;background:#0f172a;color:#fff;padding:.75rem 1rem;border-radius:.75rem;opacity:.96;z-index:70}
    .toast.ok{background:#065f46}.toast.ng{background:#7f1d1d}

    /* Tips */
    .tips-overlay{position:fixed;inset:0;z-index:80;display:none;background:rgba(15,23,42,.96);color:#fff}
    .tips-body{max-width:44rem;margin:8vh auto;padding:1.5rem}
    .tips-card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.15);border-radius:1rem;padding:1.25rem}
    .tips-actions{display:flex;gap:.5rem;justify-content:flex-end;margin-top:1rem}
    .tips-btn{background:#10b981;color:#0b1b26;border-radius:.75rem;padding:.5rem .9rem}
    .tips-btn.gray{background:#e2e8f0;color:#0b1b26}

    /* TELECUBE 画像（全体が入る・見切れ防止） */
    .telecube-img{width:100%; height:280px; object-fit:contain; background:#0b1220; border-radius:.75rem;}
    @media (min-width:1024px){ .telecube-img{ height:320px; } }

    /* ---- Compact Multi-Select (dropdown-like) ---- */
    .ms-wrap{position:relative}
    .ms-btn{width:100%;display:flex;align-items:center;justify-content:space-between;gap:.5rem;
      padding:.5rem .75rem;border-radius:.75rem;border:1px solid var(--ms-bd,#cbd5e1);
      background:transparent}
    .dark .ms-btn{--ms-bd:#334155}
    .ms-menu{position:absolute;inset:auto 0 auto 0;top:calc(100% + .25rem);z-index:50;
      background:var(--ms-bg,#fff);border:1px solid var(--ms-bd,#cbd5e1);border-radius:.75rem;
      max-height:14rem;overflow:auto;box-shadow:0 10px 20px rgba(2,6,23,.2);display:none}
    .dark .ms-menu{--ms-bg:#0f172a;--ms-bd:#334155}
    .ms-item{display:flex;align-items:center;gap:.5rem;width:100%;padding:.5rem .75rem;text-align:left}
    .ms-item:hover{background:rgba(2,6,23,.06)} .dark .ms-item:hover{background:rgba(255,255,255,.06)}
    .ms-chip{display:inline-flex;align-items:center;gap:.25rem;background:rgba(16,185,129,.12);border:1px solid rgba(16,185,129,.35);
      color:#065f46;border-radius:.75rem;padding:.125rem .5rem;font-size:.75rem}
    .dark .ms-chip{color:#bbf7d0}
    .ms-caret{margin-left:auto;opacity:.65}
  </style>
</head>
<body class="font-sans bg-slate-50 text-slate-900 selection:bg-emerald-200/60 dark:bg-slate-900 dark:text-slate-50">
  <div class="max-w-6xl mx-auto p-4 md:p-8">

    <!-- HEADER -->
    <header class="flex items-center justify-between gap-4 mb-6">
      <div class="flex items-center gap-3">
        <div class="size-10 rounded-2xl bg-emerald-500/90 flex items-center justify-center text-white font-bold">i</div>
        <div>
          <h1 class="text-xl md:text-2xl font-bold">iwasemi™｜音問題 診断サービス</h1>
          <p class="text-sm text-slate-500 dark:text-slate-400">©Pixie Dust Technologies Inc.</p>
          <p class="text-sm text-slate-500 dark:text-slate-400">入力から残響・遮音の課題を解析し、最適解と概算・導入事例を自動提示します。</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="themeToggle" class="px-3 py-2 rounded-xl border border-slate-300/60 dark:border-slate-700 text-sm"></button>
        <a href="#result" class="px-3 py-2 rounded-xl bg-emerald-600 text-white text-sm">結果を見る</a>
      </div>
    </header>

    <!-- PROGRESS -->
    <div id="progress" class="w-full h-2 bg-slate-200 dark:bg-slate-800 rounded-full overflow-hidden mb-6">
      <div id="progressBar" class="h-full w-[0%] bg-emerald-500 transition-all"></div>
    </div>

    <!-- ===== FORM ===== -->
    <form id="diagForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">

      <!-- 1-A) 顧客情報 -->
      <section class="md:col-span-2 p-4 md:p-6 rounded-2xl bg-white dark:bg-slate-800 shadow-sm">
        <h2 class="text-lg font-semibold mb-4">顧客情報</h2>
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
          <label class="block md:col-span-2">
            <span class="text-sm">企業名（顧客）</span>
            <input name="company" required class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent" placeholder="株式会社○○"/>
          </label>
          <label class="block md:col-span-1">
            <span class="text-sm">業種</span>
            <select name="industry" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
              <option>IT</option><option>製造</option><option>金融</option><option>学校</option><option>医療</option>
              <option>官公庁</option><option>BPO/コール</option><option>商業</option><option>物流</option><option>その他</option>
            </select>
          </label>
          <label class="block md:col-span-1">
            <span class="text-sm">規模</span>
            <select name="size" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
              <option>〜100名</option><option>101–500</option><option>501–1000</option><option>1001–5000</option><option>5001〜</option>
            </select>
          </label>
          <label class="block md:col-span-1">
            <span class="text-sm">都道府県</span>
            <select name="pref" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
              <option value="">選択してください</option>
              <option>北海道</option><option>青森県</option><option>岩手県</option><option>宮城県</option><option>秋田県</option><option>山形県</option><option>福島県</option>
              <option>茨城県</option><option>栃木県</option><option>群馬県</option><option>埼玉県</option><option>千葉県</option><option>東京都</option><option>神奈川県</option>
              <option>新潟県</option><option>富山県</option><option>石川県</option><option>福井県</option><option>山梨県</option><option>長野県</option>
              <option>岐阜県</option><option>静岡県</option><option>愛知県</option><option>三重県</option>
              <option>滋賀県</option><option>京都府</option><option>大阪府</option><option>兵庫県</option><option>奈良県</option><option>和歌山県</option>
              <option>鳥取県</option><option>島根県</option><option>岡山県</option><option>広島県</option><option>山口県</option>
              <option>徳島県</option><option>香川県</option><option>愛媛県</option><option>高知県</option>
              <option>福岡県</option><option>佐賀県</option><option>長崎県</option><option>熊本県</option><option>大分県</option><option>宮崎県</option><option>鹿児島県</option><option>沖縄県</option>
            </select>
          </label>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mt-4">
          <label class="block md:col-span-1">
            <span class="text-sm">実施想定時期</span>
            <select name="timeline" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
              <option>今期</option><option>来期</option><option selected>未定</option>
            </select>
          </label>
          <label class="block md:col-span-2">
            <span class="text-sm">ご担当者名（顧客）</span>
            <input name="person" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent" placeholder="山田 太郎"/>
          </label>
          <label class="block md:col-span-2">
            <span class="text-sm">メール（結果送付先）</span>
            <input name="email" type="email" required class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent" placeholder="taro@example.com"/>
          </label>
        </div>
      </section>

      <!-- 1-B) 代理店担当者情報 -->
      <section class="md:col-span-2 p-4 md:p-6 rounded-2xl bg-white dark:bg-slate-800 shadow-sm">
        <h2 class="text-lg font-semibold mb-4">代理店担当者情報</h2>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <label class="block">
            <span class="text-sm">企業名（代理店）</span>
            <input name="agentCompany" required class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent" placeholder="○○販売株式会社"/>
          </label>
          <label class="block">
            <span class="text-sm">担当者名</span>
            <input name="agentPerson" required class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent" placeholder="代理店 太郎"/>
          </label>
          <label class="block">
            <span class="text-sm">支店名</span>
            <input name="agentBranch" required class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent" placeholder="○○支店 / ○○営業部"/>
          </label>
          <label class="block">
            <span class="text-sm">メールアドレス</span>
            <input name="agentEmail" type="email" required class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent" placeholder="agency@example.com"/>
          </label>
        </div>
      </section>

      <!-- 2) 空間の基本情報 -->
      <section class="p-4 md:p-6 rounded-2xl bg-white dark:bg-slate-800 shadow-sm">
        <h2 class="text-lg font-semibold mb-4">2) 空間の基本情報</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <label class="block">
            <span class="text-sm">プロジェクト種別</span>
            <select name="project" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
              <option>移転</option><option>改修</option><option selected>既存</option>
            </select>
          </label>
          <label class="block">
            <span class="text-sm">空間カテゴリー</span>
            <select name="category" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
              <option value="office">オフィス</option>
              <option value="nonoffice">オフィス以外（工場/学校/図書館/商業/スタジオ等）</option>
            </select>
          </label>
          <label class="block">
            <span class="text-sm">空間タイプ</span>
            <select name="spaceType" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
              <option value="meeting_closed">会議室（密閉）</option>
              <option value="meeting_transom">会議室（欄間オープン）</option>
              <option value="booth_tel">ワークブース（TELECUBE）</option>
              <option value="booth_built">ワークブース（造作）</option>
              <option value="open">オープンスペース（執務室）</option>
              <option value="reception">受付</option>
              <option value="callcenter">コールセンター</option>
              <option value="studio">スタジオ</option>
              <option value="other">その他</option>
            </select>
          </label>

          <!-- 利用用途（複数選択可） -->
          <label class="block">
            <span class="text-sm">利用用途（複数選択可）</span>
            <select name="use" multiple class="mt-1 w-full ms-native">
              <option value="meeting_multi">会議（複数人）</option>
              <option value="meeting_1to1">会議（1対1/少人数）</option>
              <option value="meeting_web">会議（Webメイン）</option>
              <option value="meeting_f2f">会議（対面メイン）</option>
              <option value="meeting_hybrid">会議（対面＋Web）</option>
              <option value="exec">役員会議</option>
              <option value="internal">社内会議</option>
              <option value="external">社外会議</option>
              <option value="focus">集中作業</option>
              <option value="phone">電話（個人/顧客）</option>
              <option value="websolo">Web会議（1人）</option>
              <option value="music">音楽鑑賞</option>
              <option value="stream">配信・収録</option>
            </select>
          </label>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
          <label class="block">
            <span class="text-sm">騒音源（複数選択可）</span>
            <select name="source" multiple class="mt-1 w-full ms-native">
              <option value="speech">人の声</option>
              <option value="machine">機械音</option>
              <option value="invasion_ext">外部からの音の侵入</option>
            </select>
          </label>
          <label class="block">
            <span class="text-sm">従業員の声（うるささ）</span>
            <select name="complaint" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
              <option value="low">低</option><option value="mid" selected>中</option><option value="high">高</option>
            </select>
          </label>
          <label class="block">
            <span class="text-sm">既存対策（複数選択可）</span>
            <select name="measure" multiple class="mt-1 w-full ms-native">
              <option value="partition">パーティション</option>
              <option value="absorption">吸音パネル</option>
              <option value="masking">サウンドマスキング</option>
              <option value="none">特になし</option>
            </select>
          </label>
        </div>
      </section>

      <!-- 3) 空間サイズ・構成要素 -->
      <section class="p-4 md:p-6 rounded-2xl bg-white dark:bg-slate-800 shadow-sm">
        <h2 class="text-lg font-semibold mb-4">空間サイズ・構成要素</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <label class="block"><span class="text-sm">床面積（㎡/室）</span>
            <input name="area" type="number" min="1" step="0.1" value="20" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent"/>
          </label>
          <label class="block"><span class="text-sm">室数（同仕様）</span>
            <input name="rooms" type="number" min="1" value="1" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent"/>
          </label>
          <label class="block"><span class="text-sm">天井高</span>
            <select name="ceilHeight" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
              <option value="lt2_5">2.5m未満</option>
              <option value="2_5_3_0" selected>2.5〜3.0m</option>
              <option value="3_0_3_5">3.0〜3.5m</option>
              <option value="gt3_5">3.5m以上</option>
              <option value="unknown">不明</option>
            </select>
          </label>
        </div>

        <!-- 壁材（4面） -->
        <div class="mt-4">
          <span class="text-sm block mb-2">壁材（4面）</span>
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <label class="block"><span class="text-xs text-slate-500">壁①</span>
              <select name="wall1" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
                <option value="gypsum">石膏ボード＋クロス</option>
                <option value="glass_s">ガラス（シングル）</option>
                <option value="glass_d">ガラス（ダブル）</option>
                <option value="rc">コンクリート打放し</option>
                <option value="abs_finish">吸音パネル仕上げ</option>
                <option value="wood">木質</option>
                <option value="steel_part">スチールパーティション</option>
                <option value="unknown">不明</option>
              </select>
            </label>
            <label class="block"><span class="text-xs text-slate-500">壁②</span>
              <select name="wall2" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
                <option value="gypsum">石膏ボード＋クロス</option>
                <option value="glass_s">ガラス（シングル）</option>
                <option value="glass_d">ガラス（ダブル）</option>
                <option value="rc">コンクリート打放し</option>
                <option value="abs_finish">吸音パネル仕上げ</option>
                <option value="wood">木質</option>
                <option value="steel_part">スチールパーティション</option>
                <option value="unknown">不明</option>
              </select>
            </label>
            <label class="block"><span class="text-xs text-slate-500">壁③</span>
              <select name="wall3" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
                <option value="gypsum">石膏ボード＋クロス</option>
                <option value="glass_s">ガラス（シングル）</option>
                <option value="glass_d">ガラス（ダブル）</option>
                <option value="rc">コンクリート打放し</option>
                <option value="abs_finish">吸音パネル仕上げ</option>
                <option value="wood">木質</option>
                <option value="steel_part">スチールパーティション</option>
                <option value="unknown">不明</option>
              </select>
            </label>
            <label class="block"><span class="text-xs text-slate-500">壁④</span>
              <select name="wall4" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
                <option value="gypsum">石膏ボード＋クロス</option>
                <option value="glass_s">ガラス（シングル）</option>
                <option value="glass_d">ガラス（ダブル）</option>
                <option value="rc">コンクリート打放し</option>
                <option value="abs_finish">吸音パネル仕上げ</option>
                <option value="wood">木質</option>
                <option value="steel_part">スチールパーティション</option>
                <option value="unknown">不明</option>
              </select>
            </label>
          </div>
        </div>

        <!-- 床・天井・扉・ガラス・その他 -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
          <label class="block"><span class="text-sm">床材</span>
            <select name="floor" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
              <option value="carpet">タイルカーペット</option>
              <option value="wood">フローリング</</option>
              <option value="pvc">塩ビシート（PVC）</option>
              <option value="tile_stone">タイル・石材</option>
              <option value="unknown">不明</option>
            </select>
          </label>
          <label class="block"><span class="text-sm">天井材</span>
            <select name="ceiling" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
              <option value="pb">化粧石膏ボード</option>
              <option value="mineral_grid">岩綿吸音板（グリッド）</option>
              <option value="metal">金属パネル天井</option>
              <option value="exposed">露出天井（スケルトン）</option>
              <option value="unknown">不明</option>
            </select>
          </label>
          <label class="block"><span class="text-sm">扉の種類</span>
            <select name="door" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
              <option value="wood_solid">木製（単板）</option>
              <option value="wood_honeycomb">木製（中空ハニカム）</option>
              <option value="glass_s">ガラス（シングル）</option>
              <option value="glass_d">ガラス（ダブル）</option>
              <option value="steel">スチールドア</option>
              <option value="unknown">不明</option>
            </select>
          </label>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
          <label class="block"><span class="text-sm">扉の隙間処理</span>
            <select name="doorSeal" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
              <option value="gasket">ゴムパッキンあり（遮音）</option>
              <option value="bottom">ドアボトムシールあり</option>
              <option value="gap">隙間あり（標準）</option>
              <option value="unknown">不明</option>
            </select>
          </label>
          <label class="block"><span class="text-sm">ガラスの種類</span>
            <select name="glazing" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
              <option value="single">シングルガラス</option>
              <option value="double">ダブルガラス（ペア）</option>
              <option value="unknown">不明</option>
            </select>
          </label>
        </div>

        <div class="mt-4">
          <span class="text-sm block mb-1">特徴（複数選択可）</span>
          <select name="feature" multiple class="w-full ms-native">
            <option value="transom">欄間オープン</option>
            <option value="shared_plenum">共有天井裏（隣室と連続）</option>
            <option value="grille">ガラリ／換気開口あり</option>
            <option value="gap_door_bottom">ドア下の隙間</option>
            <option value="gap_frame">枠まわりの隙間</option>
            <option value="gap_penetration">貫通部の隙間</option>
            <option value="gap_duct">ダクト等の隙間</option>
          </select>
        </div>
      </section>

      <!-- 4) 期待効果・制約 -->
      <section class="md:col-span-2 p-4 md:p-6 rounded-2xl bg-white dark:bg-slate-800 shadow-sm">
        <h2 class="text-lg font-semibold mb-4">期待する効果・制約</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <label class="block">
            <span class="text-sm">期待する効果（複数選択可）</span>
            <select name="effect" multiple class="mt-1 w-full ms-native">
              <option value="clarity_meeting">会議の聞き取り</option>
              <option value="clarity_web">Web会議の聞き取り</option>
              <option value="speaking">話しやすさ</option>
              <option value="focus">集中力向上</option>
              <option value="leakage">音漏れの低減</option>
            </select>
          </label>
          <label class="block">
            <span class="text-sm">改修許容（施工可否）</span>
            <select name="work" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
              <option value="night">夜間可</option><option value="weekend">週末のみ</option><option value="inhours">営業時間内のみ</option>
            </select>
          </label>
          <label class="block">
            <span class="text-sm">完全遮音（音漏れゼロ）希望</span>
            <select name="zeroLeak" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
              <option value="no">いいえ</option><option value="yes">はい</option>
            </select>
          </label>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
          <label class="block md:col-span-1">
            <span class="text-sm">自己評価：現状の音環境（0=悪い〜10=良い）</span>
            <input name="selfScore" type="number" min="0" max="10" value="5" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent"/>
          </label>
        </div>

        <div id="effectsError" class="text-xs text-red-600 mt-2 hidden">
          「期待する効果」はどれか1つ以上選択してください。
        </div>
      </section>

      <!-- 操作 -->
      <div class="md:col-span-2 flex flex-wrap gap-3 justify-end">
        <button type="button" id="resetBtn" class="px-4 py-2 rounded-xl border border-slate-300 dark:border-slate-700">リセット</button>
        <button type="button" id="diagnoseBtn" class="px-5 py-2.5 rounded-xl bg-emerald-600 text-white">診断する</button>
      </div>
    </form>

    <!-- ===== RESULT ===== -->
    <section id="result" class="mt-10 p-4 md:p-6 rounded-2xl bg-white dark:bg-slate-800 shadow-sm">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold">診断結果</h2>
        <div class="flex gap-2">
          <button id="downloadJson" class="px-3 py-2 rounded-xl border border-slate-300 dark:border-slate-700 text-sm">JSONダウンロード</button>
          <button id="printBtn" class="px-3 py-2 rounded-xl bg-slate-900 text-white text-sm dark:bg-slate-100 dark:text-slate-900">印刷 / PDF</button>
        </div>
      </div>

      <!-- 0) 提案サマリー -->
      <div id="proposalSummary" class="mt-4 w-full"></div>

      <!-- 1) エビデンス -->
      <div id="evidenceWrap" class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4"></div>

      <!-- 2) 詳細レコメンド -->
      <div id="recommendWrap" class="mt-6 grid grid-cols-1 lg:grid-cols-3 gap-4"></div>

      <!-- 3) iwasemi見積（詳細：3製品） -->
      <div id="iwasemiWrap" class="mt-6"></div>

      <!-- 4) 近い導入事例（※TELECUBE時は非表示） -->
      <div id="caseWrap" class="mt-6"></div>

      <!-- 5) TELECUBE 参考事例（TELECUBE時のみ表示） -->
      <div id="telecubeWrap" class="mt-6"></div>

      <!-- 6) 残響時間グラフ（詳細版は非表示のまま） -->
      <div id="rtChartWrap" class="mt-6 hidden">
        <div class="p-4 md:p-5 rounded-2xl border border-slate-200 dark:border-slate-700">
          <div class="text-base font-semibold mb-2">残響時間シミュレーション</div>
          <div class="text-xs text-slate-500 mb-3" id="rtChartSummary">
            目標：会議室の目安とする残響時間は <b>0.6秒</b> です（用途により自動補正）。
          </div>
          <div class="relative" style="height:340px">
            <canvas id="rtChart" aria-label="残響時間グラフ" role="img"></canvas>
          </div>
        </div>
      </div>

      <!-- 備考 -->
      <div id="notesWrap" class="mt-6"></div>
    </section>

    <footer class="text-sm text-slate-500 dark:text-slate-400 mt-10">©Pixie Dust Technologies Inc.</footer>
  </div>

  <div id="toast" class="hidden"></div>

  <!-- Tips Overlay -->
  <div id="tipsOverlay" class="tips-overlay" role="dialog" aria-modal="true" aria-label="注意事項">
    <div class="tips-body">
      <div class="tips-card">
        <h3 class="text-xl font-semibold mb-2">開口部からの音の回り込みに注意</h3>
        <p class="text-sm opacity-90">
          欄間オープン／共有天井（プレナム共有）／ガラリ・換気開口は、隣室への<strong>音の回り込み経路</strong>になり、会話漏れ・プライバシー低下の主因となります。
          上部のインフィル（塞ぎ）、開口のライニング・ダクト化、ドア・枠まわりの隙間封止などの<strong>経路対策</strong>をご検討ください。
        </p>
        <ul class="list-disc pl-5 mt-2 text-sm opacity-90">
          <li>欄間：上部インフィル（遮音ボード＋シーリング）</li>
          <li>共有天井：プレナム内の連通部にバリア設置</li>
          <li>ガラリ：ライニング（吸音材）付きダクトやサウンドトラップ</li>
          <li>扉・枠：ガスケット、ドアボトムシールで隙間低減</li>
        </ul>
        <p id="tipsExtra" class="text-xs mt-2 opacity-80"></p>
        <div class="tips-actions">
          <button class="tips-btn gray" onclick="hideTips()">閉じる</button>
          <button class="tips-btn" onclick="hideTips()">了解</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ========== helpers ========== */
    const $ = (sel, el=document)=> el.querySelector(sel);
    const $$ = (sel, el=document)=> Array.from(el.querySelectorAll(sel));
    const enc = (s)=> encodeURIComponent(s||'');
    const yen = (n)=> '¥' + (Math.round(n)||0).toLocaleString('ja-JP');
    const fmt2 = (n)=> (Math.round((n??0)*100)/100).toFixed(2);

    // Theme
    const themeBtn = $('#themeToggle');
    function setTheme(mode){
      if(mode==='dark'){ document.documentElement.classList.add('dark'); localStorage.setItem('theme','dark'); themeBtn.textContent='ライト'; }
      else { document.documentElement.classList.remove('dark'); localStorage.setItem('theme','light'); themeBtn.textContent='ダーク'; }
    }
    themeBtn.addEventListener('click',()=> setTheme(document.documentElement.classList.contains('dark')?'light':'dark'));
    setTheme(localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light'));

    // Toast
    function toast(msg, ok=true){ const t=$('#toast'); t.className='toast '+(ok?'ok':'ng'); t.textContent=msg; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'),3200); }

    // Progress
    const formEl = $('#diagForm'); const progressBar = $('#progressBar');
    function getMulti(name){
      const sel = formEl.elements[name];
      if (!sel) return [];
      if (sel instanceof HTMLSelectElement && sel.multiple) {
        return Array.from(sel.selectedOptions).map(o=>o.value);
      }
      return $$(`select[name='${name}'] option:checked`, formEl).map(o=>o.value);
    }
    function updateProgress(){
      const req = $$('input[required], select[required]', formEl);
      const filled = req.filter(i => i.value && i.value.trim() !== '' && i.checkValidity());
      const effectChecked = getMulti('effect').length > 0;
      const total = req.length + 1; // +1 = 効果グループ
      const done  = filled.length + (effectChecked ? 1 : 0);
      const p = total ? Math.round((done/total)*100) : 100;
      progressBar.style.width = Math.min(100, Math.max(10, p)) + '%';
    }
    formEl.addEventListener('input', updateProgress);
    formEl.addEventListener('change', updateProgress);
    updateProgress();

    // Tips overlay
    function showTips(opts={}){ if(opts.transom){ $('#tipsExtra').innerHTML='欄間オープンの場合でも、壁面が硬質だと室内が反響しやすくなります。<strong>吸音</strong>で響きを抑えると回り込み軽減に寄与する場合があります。'; } else { $('#tipsExtra').textContent=''; } $('#tipsOverlay').style.display='block'; }
    function hideTips(){ $('#tipsOverlay').style.display='none'; }

    // Collect
    function collect(){
      const fd = new FormData(formEl);
      return {
        // 顧客
        company: fd.get('company')||'', person: fd.get('person')||'', email: fd.get('email')||'',
        industry: fd.get('industry')||'', size: fd.get('size')||'', pref: fd.get('pref')||'', timeline: fd.get('timeline')||'未定',
        // 代理店
        agentCompany: fd.get('agentCompany')||'', agentPerson: fd.get('agentPerson')||'', agentBranch: fd.get('agentBranch')||'', agentEmail: fd.get('agentEmail')||'',
        // 空間
        project: fd.get('project')||'既存', category: fd.get('category')||'office', spaceType: fd.get('spaceType')||'meeting_closed',
        uses: getMulti('use'), sources: getMulti('source'), complaint: fd.get('complaint')||'mid', measures: getMulti('measure'),
        // 構成
        area: Number(fd.get('area')||0), rooms: Number(fd.get('rooms')||1), ceilHeight: fd.get('ceilHeight')||'2_5_3_0',
        walls: [fd.get('wall1')||'gypsum', fd.get('wall2')||'gypsum', fd.get('wall3')||'gypsum', fd.get('wall4')||'gypsum'],
        floor: fd.get('floor')||'carpet', ceiling: fd.get('ceiling')||'pb', door: fd.get('door')||'wood_solid', doorSeal: fd.get('doorSeal')||'gasket',
        glazing: fd.get('glazing')||'single', features: getMulti('feature'),
        // 効果・制約
        effects: getMulti('effect'), work: fd.get('work')||'night', zeroLeak: fd.get('zeroLeak')==='yes', selfScore: Number(fd.get('selfScore')||5)
      };
    }

    // ===== バリデーション =====
    function setInvalid(el, on){
      if(!el) return;
      el.classList.toggle('border-red-500', !!on);
      el.setAttribute('aria-invalid', on ? 'true' : 'false');
    }
    function validateRequiredFields(){
      const missing = [];
      const agentNames = ['agentCompany','agentPerson','agentBranch','agentEmail'];
      agentNames.forEach(name => {
        const el = formEl.elements[name];
        setInvalid(el, false);
        if(!el || !el.value || !el.checkValidity()){
          setInvalid(el, true);
          missing.push(el);
        }
      });
      const effectChecked = getMulti('effect').length > 0;
      const effectsError = $('#effectsError');
      if(!effectChecked){ effectsError?.classList.remove('hidden'); missing.push(formEl.elements['effect']||effectsError); }
      else { effectsError?.classList.add('hidden'); }

      if(missing.length){
        const first = missing[0];
        try{ first.scrollIntoView({behavior:'smooth', block:'center'}); }catch(_){}
        try{ first.focus({preventScroll:true}); }catch(_){}
        toast('必須項目を入力してください（代理店情報と「期待する効果」）', false);
        return false;
      }
      return true;
    }

    /* ========== acoustics (background) ========== */
    const alpha = {
      gypsum:{a500:0.06,a1000:0.06}, rc:{a500:0.02,a1000:0.02},
      glass_s:{a500:0.15,a1000:0.10}, glass_d:{a500:0.12,a1000:0.10},
      abs_finish:{a500:0.30,a1000:0.30}, wood:{a500:0.10,a1000:0.08},
      steel_part:{a500:0.07,a1000:0.06}, unknown:{a500:0.06,a1000:0.06},
      carpet:{a500:0.21,a1000:0.26}, wood_f:{a500:0.10,a1000:0.08}, pvc:{a500:0.02,a1000:0.02}, tile_stone:{a500:0.02,a1000:0.02}, floor_unknown:{a500:0.10,a1000:0.08},
      pb:{a500:0.10,a1000:0.08}, mineral_grid:{a500:0.45,a1000:0.55}, metal:{a500:0.10,a1000:0.10}, exposed:{a500:0.05,a1000:0.05}, ceil_unknown:{a500:0.10,a1000:0.08}
    };
    const getAlphaWall = (k)=> alpha[k]||alpha.gypsum;
    const getAlphaFloor = (k)=> ({carpet:alpha.carpet, wood:alpha.wood_f, pvc:alpha.pvc, tile_stone:alpha.tile_stone}[k]||alpha.floor_unknown);
    const getAlphaCeil = (k)=> alpha[k]||alpha.ceil_unknown;

    function heightFromKey(k){ if(k==='lt2_5')return 2.4; if(k==='2_5_3_0')return 2.75; if(k==='3_0_3_5')return 3.25; if(k==='gt3_5')return 3.8; return 2.7; }
    function rtTarget(spaceType, uses){
      let t=0.6;
      if(spaceType==='booth_tel'||spaceType==='booth_built') t=0.35;
      else if(spaceType==='open'||spaceType==='callcenter') t=0.7;
      else if(spaceType==='studio') t=0.3;
      if(uses.includes('stream')) t*=0.85;
      if(uses.includes('music')) t*=0.9;
      return t;
    }

    function calcRT(d){
      const A = Math.max(0.1, d.area); const H = heightFromKey(d.ceilHeight); const V = A*H;
      const s = Math.sqrt(A); const wallAreas=[s*H,s*H,s*H,s*H]; const floorArea=A; const ceilArea=A;
      const aw = d.walls.map(getAlphaWall), af=getAlphaFloor(d.floor), ac=getAlphaCeil(d.ceiling);
      const walls500 = aw[0].a500*wallAreas[0] + aw[1].a500*wallAreas[1] + aw[2].a500*wallAreas[2] + aw[3].a500*wallAreas[3];
      const walls1000= aw[0].a1000*wallAreas[0]+ aw[1].a1000*wallAreas[1]+ aw[2].a1000*wallAreas[2]+ aw[3].a1000*wallAreas[3];
      const floor500=af.a500*floorArea, floor1000=af.a1000*floorArea;
      const CEIL_EFF=0.60;
      const Aceil500=ac.a500*ceilArea*CEIL_EFF, Aceil1000=ac.a1000*ceilArea*CEIL_EFF;
      const Aflat500=walls500+floor500, Aflat1000=walls1000+floor1000;
      const cap=0.45;
      const Aeq500 = Math.min(Aflat500/(1-cap), Aflat500 + Aceil500);
      const Aeq1000= Math.min(Aflat1000/(1-cap), Aflat1000+ Aceil1000);
      const T500 = 0.161 * V / Math.max(0.001, Aeq500);
      const T1000= 0.161 * V / Math.max(0.001, Aeq1000);

      // 6帯域の簡易推定（500/1000からの線形近似）
      const freqs=[250,500,1000,2000,4000,8000];
      const Aeq_values=freqs.map(f=>{
        if(f===500) return Aeq500;
        if(f===1000) return Aeq1000;
        const r=f<500 ? 0.6 : f<1000 ? (f-500)/500 : f<2000 ? 0.6+(f-1000)/2000 : 0.85+(f-2000)/6000;
        return Aeq500*(1-r)+Aeq1000*r;
      });
      const T_values=Aeq_values.map(Aeq=>0.161*V/Math.max(0.001,Aeq));
      return { V,A,H,s,wallAreas,floorArea,ceilArea,Aeq500,Aeq1000,T500,T1000, Aeq_values, T_values };
    }

    // Scores
    function scoreAbs(d, rt){
      if (d.spaceType==='booth_tel') return null;
      const Ttgt = rtTarget(d.spaceType, d.uses);
      const Tavg = (rt.T500 + rt.T1000)/2;
      const r = Math.max(1, Tavg / Ttgt);
      const RCAP=1.9;
      let s = Math.round(100 * Math.min(1, Math.log(r)/Math.log(RCAP)));
      const U = new Set(d.uses);
      if (U.has('meeting_web') || U.has('meeting_hybrid') || U.has('websolo')) s += 3;
      if (d.ceiling==='mineral_grid') s = Math.max(8,s);
      return Math.max(0, Math.min(100, s));
    }
    function isolationIndicators(d){
      const indicators={
        extInvasion: d.sources.includes('invasion_ext')?1:0,
        transom: d.features.includes('transom')?1:0,
        plenum: d.features.includes('shared_plenum')?1:0,
        grille: d.features.includes('grille')?1:0,
        gaps: ['gap_door_bottom','gap_frame','gap_penetration','gap_duct'].some(k=>d.features.includes(k))?1:0
      };
      const any = Object.values(indicators).some(v=>v===1);
      return {indicators, any};
    }
    function wallStatsForIsl(walls){ const cnt=t=>walls.filter(w=>t.includes(w)).length; return {glassCount:cnt(['glass_s','glass_d']), rcCount:cnt(['rc'])}; }
    function scoreIsl(d, rt){
      if (d.spaceType==='booth_tel') return null;
      let s=0; const {indicators, any}=isolationIndicators(d); const ws=wallStatsForIsl(d.walls);
      if (indicators.transom) s+=28; if (indicators.plenum) s+=28; if (indicators.grille) s+=22; if (indicators.gaps) s+=12;
      if (indicators.extInvasion) s+=24;
      if (d.door==='wood_honeycomb') s+=12; if (d.door==='glass_s'||d.door==='glass_d') s+=10; if (d.door==='steel') s-=8;
      if (d.doorSeal==='gap') s+=10; if (d.doorSeal==='gasket') s-=5;
      if (d.glazing==='single') s+=8; if (d.glazing==='double') s-=6;
      if (ws.glassCount>=2) s+=8; else if (ws.glassCount===1) s+=5; if (ws.rcCount>=2) s-=8;
      if (['exec','external'].some(u=>d.uses.includes(u))) s+= any?6:3;
      if (!any) s = Math.min(s,35);
      const Ttgt=rtTarget(d.spaceType,d.uses), Tavg=(rt.T500+rt.T1000)/2, ratio=Tavg/Ttgt;
      if (ratio>=1.5 && s<40) s*=0.6; else if (ratio>=1.3 && s<50) s*=0.7;
      return Math.max(0, Math.round(s));
    }

    /* ========== iwasemi 製品定義（※面積修正反映） ========== */
    const FREQS = [250, 500, 1000, 2000, 4000, 8000];
    const FREQ_LABELS = FREQS.map(f => f + 'Hz');

    const PRODUCTS = {
      rc: {
        key: 'rc',
        name: 'iwasemi RC-α',
        panelArea: 0.03, // 代表値（実測値があれば更新）
        alpha: { 250: 0.05, 500: 0.35, 1000: 0.76, 2000: 0.22, 4000: 0.11, 8000: 0.13 }
      },
      sq: {
        key: 'sq',
        name: 'iwasemi SQ-α',
        panelArea: 0.050625, // ← 修正値
        alpha: { 250: 0.13, 500: 0.70, 1000: 0.66, 2000: 0.17, 4000: 0.08, 8000: 0.07 }
      },
      hx: {
        key: 'hx',
        name: 'iwasemi HX-α',
        panelArea: 0.0286862, // ← 修正値
        alpha: { 250: 0.09, 500: 0.56, 1000: 0.85, 2000: 0.21, 4000: 0.12, 8000: 0.06 }
      }
    };
    function alphaVec(p){ return FREQS.map(f => p.alpha[f]); }

    /* ========== パネル枚数ロジック ========== */
    // RC/HX：従来アンカー補間
    const PANEL_ANCHORS=[
      {a:5,p:50},{a:10,p:100},{a:15,p:150},{a:20,p:190},{a:25,p:230},{a:30,p:270},
      {a:40,p:350},{a:50,p:430},{a:60,p:500},{a:80,p:640},{a:100,p:770}
    ];
    function interpPanels(area){
      if (area<=PANEL_ANCHORS[0].a) return PANEL_ANCHORS[0].p;
      for (let i=1;i<PANEL_ANCHORS.length;i++){ const lo=PANEL_ANCHORS[i-1], hi=PANEL_ANCHORS[i];
        if (area<=hi.a){ const t=(area-lo.a)/(hi.a-lo.a); return Math.round(lo.p + t*(hi.p-lo.p)); } }
      const last=PANEL_ANCHORS[PANEL_ANCHORS.length-1], prev=PANEL_ANCHORS[PANEL_ANCHORS.length-2];
      const slope=(last.p-prev.p)/(last.a-prev.a); return Math.round(last.p + (area-last.a)*slope);
    }
    // SQ：提示式
    function panelsSQ(area){
      if (area <= 0) return 0;
      const isInt = Math.abs(area - Math.round(area)) < 1e-9;
      if (isInt) {
        const A = Math.round(area);
        return (A >= 1) ? (5*A + 5) : 5;
      } else {
        return 5*(Math.ceil(area)+1);
      }
    }

    const UNIT_PRICE=5000;

    function buildPanelSolutionsForProduct(d, primaryKey, rt, productKey){
      const rooms = Math.max(1, Math.round(d.rooms));
      const area = Math.max(0.1, d.area);

      let perRoomStd = 0;
      if (productKey === 'sq') perRoomStd = panelsSQ(area);
      else perRoomStd = interpPanels(area); // rc/hx

      const totalStd = perRoomStd * rooms;
      const totalPro = Math.max(totalStd+1, Math.round(totalStd*1.2));

      function bomFor(panels, withSeal){
        const parts=[]; const pricePanels=panels*UNIT_PRICE; parts.push({name:`${PRODUCTS[productKey].name}`, qty:panels, price:pricePanels});
        let extras=0;
        if (withSeal){ const seal=15000*rooms; parts.push({name:'隙間封止（参考費用・別途手配）', qty:rooms, price:seal}); extras+=seal; }
        const install=Math.round(pricePanels*0.20); parts.push({name:'仮設・夜間施工（概算）', qty:1, price:install});
        const subtotal=pricePanels+extras+install; return {bom:parts, subtotal};
      }

      const needSeal=(primaryKey==='abs_plus_seal' || primaryKey==='isolation');
      const std=bomFor(totalStd, needSeal), pro=bomFor(totalPro, needSeal);

      return {
        product: PRODUCTS[productKey],
        perRoomStd, totalStd, totalPro,
        Ttgt: rtTarget(d.spaceType,d.uses),
        plans:[
          {name:'標準', panels:totalStd, bom:std.bom, subtotal:std.subtotal},
          {name:'強め', panels:totalPro, bom:pro.bom, subtotal:pro.subtotal}
        ]
      };
    }

    function buildAllPanelSolutions(d, primaryKey, rt){
      return {
        rc: buildPanelSolutionsForProduct(d, primaryKey, rt, 'rc'),
        sq: buildPanelSolutionsForProduct(d, primaryKey, rt, 'sq'),
        hx: buildPanelSolutionsForProduct(d, primaryKey, rt, 'hx')
      };
    }

    /* ========== Recommend（文章） ========== */
    function recommend(d, S, rt){
      const list=[]; const ratio=((rt.T500+rt.T1000)/2)/rtTarget(d.spaceType,d.uses); const {any}=isolationIndicators(d);
      const TEXT={
        booth_abs:'ブース内で残響（音の響き）が強く声がこもりやすいため、ガラスや金属面に小型吸音パネルを分散配置することが効果的です。',
        abs_high:'残響（音の響き）が目標値を上回っており、会話の明瞭度や聞き取りやすさの改善には壁や天井への吸音パネル設置が有効です。',
        abs_mid:'残響（音の響き）がやや強いため、一部エリアから吸音パネルを段階的に導入して響きを整えることが効果的です。',
        measure:'残響（音の響き）はおおむね良好ですが、導入前に響きの測定や体感トライアルで最適な吸音量を確認することが有効です。',
        abs_seal:'声が隣に漏れやすく、室内の残響（音の響き）も強いため、すき間をふさぎつつ吸音で音漏れを軽減することが効果的です。',
        isolation:'残響（音の響き）に加え、欄間や天井、ドアまわりから音が伝わりやすいため、仕切り設置や遮音対策を行うことが有効です。'
      };

      if (S.S_abs===null && S.S_isl===null){
        list.push({key:'absorption',label:'吸音（ブース内面）',priority:'高',score:50,reason:TEXT.booth_abs});
        return list;
      }

      if (S.S_abs<12 && S.S_isl<40){
        list.push({key:'measure',label:'計測／トライアル',priority:'高',score:50,reason:TEXT.measure}); return list;
      }

      if (S.S_isl>=60 || (d.zeroLeak && any)){
        list.push({key:'isolation',label:'遮音',priority:'高',score:S.S_isl,reason:TEXT.isolation});
      } else if (S.S_isl>=45){
        list.push({key:'abs_plus_seal',label:'吸音＋隙間対策',priority:'高',score:S.S_isl + Math.min(12,0.25*(S.S_abs||0)),reason:TEXT.abs_seal});
      } else if (ratio>=1.3 && (S.S_abs||0)>=12){
        list.push({key:'absorption',label:'吸音',priority:'高',score:S.S_abs,reason:TEXT.abs_high});
      } else {
        list.push({key:'measure',label:'計測／トライアル',priority:'高',score:50,reason:TEXT.measure});
      }

      const hasAbs=list.some(x=>x.key==='absorption'||x.key==='abs_plus_seal');
      if (!hasAbs && (S.S_abs||0)>=12){
        list.push({key:'absorption',label:'吸音',priority:'中',score:Math.max(30,S.S_abs),reason:TEXT.abs_mid});
      }
      if (!list.some(x=>x.key==='isolation') && (S.S_isl||0)>=40){
        list.push({key:'abs_plus_seal',label:'吸音＋隙間対策',priority:'低',score:S.S_isl,reason:TEXT.abs_seal});
      }
      return list.slice(0,3).sort((a,b)=>b.score-a.score);
    }

    /* ========== Render ========== */
    function clearResult(){
      $('#proposalSummary').innerHTML=''; $('#evidenceWrap').innerHTML='';
      $('#recommendWrap').innerHTML=''; $('#iwasemiWrap').innerHTML='';
      $('#caseWrap').innerHTML=''; $('#telecubeWrap').innerHTML=''; $('#notesWrap').innerHTML='';
      $('#rtChartWrap').classList.add('hidden');
      if (window.myRtChart) { try{ window.myRtChart.destroy(); }catch(e){} window.myRtChart=null; }
      if (window.myRtChartInline) { try{ window.myRtChartInline.destroy(); }catch(e){} window.myRtChartInline=null; }
    }
    function cardExplainAbs(s){ if(s>=70)return'吸音材の導入が強く推奨されます（高残響）。'; if(s>=40)return'吸音導入で明瞭度の改善が期待できます。'; if(s>=12)return'軽微な吸音でも改善が見込めます。'; return'現状、吸音の必要性は小さいと推定されます。'; }
    function cardExplainIsl(s){ if(s>=60)return'遮音工事が主目的（欄間・共有天井・隙間等の経路対策）。'; if(s>=45)return'隙間封止等の簡易遮音と吸音の併用が有効です。'; if(s>=30)return'軽微な回り込み対策を検討してください。'; return'現状、遮音（漏れ/侵入）の優先度は高くありません。'; }
    function evidenceLines(d,S,rt){
      const Ttgt=rtTarget(d.spaceType,d.uses); const Tavg=(rt.T500+rt.T1000)/2; const ratio=Tavg/Ttgt;
      const feats=[]; if(d.features.includes('transom'))feats.push('欄間オープン'); if(d.features.includes('shared_plenum'))feats.push('共有天井裏'); if(d.features.includes('grille'))feats.push('ガラリ/換気開口');
      if(['gap_door_bottom','gap_frame','gap_penetration','gap_duct'].some(x=>d.features.includes(x)))feats.push('隙間あり'); if(d.sources.includes('invasion_ext'))feats.push('外部からの音の侵入');
      return {
        line1:`残響時間：平均 ${fmt2(Tavg)}s / 目標 ${fmt2(Ttgt)}s（比 ${fmt2(ratio)}）`,
        line2:`吸音必要度 ${(S.S_abs??'—')} / 遮音必要度 ${(S.S_isl??'—')}（スケール：0〜100）`,
        line3:`回り込みの要因：${feats.length?feats.join('・'):'特になし'}`,
        explainRT: ratio>=1.3 ? '目標より残響時間が長いため、吸音導入で明瞭度の改善が見込めます。' : ratio<=0.9 ? '残響時間は良好な範囲です。吸音は補助的で十分な可能性があります。' : '残響時間はほぼ目標範囲です。用途により軽微な吸音で調整可能です。',
        explainLeak: (S.S_isl??0)>=45 ? '欄間・共有天井や隙間等の回り込みが疑われます。隙間封止/遮音対策を検討ください。' : (S.S_isl??0)>=30 ? '軽微な回り込みの可能性があります。簡易対策で改善余地。' : '明確な回り込み要素は小さめです。'
      };
    }

    function renderProposalSummary(d, recs, S, rt, allPanelSols){
      const top = recs[0];

      // Price range across 3 products (標準〜強め)
      const allPlans = Object.values(allPanelSols).flatMap(ps => ps.plans);
      const minStd = Math.min(...allPlans.filter(p=>p.name==='標準').map(p=>p.subtotal));
      const maxPro = Math.max(...allPlans.filter(p=>p.name==='強め').map(p=>p.subtotal));
      let priceLine = `<span class="badge bg-white/60 dark:bg-slate-800/60">別途見積</span>`;
      if (['吸音','吸音＋隙間対策','吸音（ブース内面）'].includes(top.label) || ['absorption','abs_plus_seal'].includes(top.key)){
        priceLine = `<span class="tabular-nums font-semibold">${yen(minStd)}〜${yen(maxPro)}</span> <span class="text-xs text-slate-500">（概算・税抜）</span>`;
      }

      const CTA = `
        <div class="mt-3 grid grid-cols-1 md:grid-cols-3 gap-3">
          <a class="w-full text-center px-3 py-2 rounded-xl bg-emerald-600 text-white text-sm" href="https://forms.gle/7bs1AjPXniCqnZcJ7" target="_blank" rel="noopener">トライアルを申し込む</a>
          <a class="w-full text-center px-3 py-2 rounded-xl bg-slate-900 text-white text-sm dark:bg-slate-100 dark:text-slate-900" href="https://meetings.hubspot.com/sakiho-shiraiwa" target="_blank" rel="noopener">担当者と打ち合わせ</a>
          <a class="w-full text-center px-3 py-2 rounded-xl bg-slate-700 text-white text-sm" href="https://share.hsforms.com/1Kk4-c1IGRxezpKRrXRdfpwswr6j" target="_blank" rel="noopener">お問い合わせ</a>
        </div>`;

      const contact = `
        <div class="mt-3 text-xs text-slate-600 dark:text-slate-300">
          <div class="font-semibold">iwasemi担当：白岩（しらいわ）</div>
          <div>電話：090-8389-3420　/　メール：<a class="underline" href="mailto:support_iwasemi@pixiedusttech.com">support_iwasemi@pixiedusttech.com</a></div>
        </div>`;

      $('#proposalSummary').innerHTML = `
        <div class="w-full p-4 md:p-5 rounded-2xl border border-emerald-300/50 bg-emerald-50/60 dark:bg-emerald-900/20 dark:border-emerald-700">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
            <div>
              <div class="text-sm text-emerald-900/80 dark:text-emerald-100/80">今回のご提案（結論）</div>
              <div class="mt-1 text-xl font-semibold">解決カテゴリ：${top.label} <span class="badge">${top.priority}</span></div>
              <p class="text-sm mt-1 text-emerald-900/85 dark:text-emerald-100/85">${top.reason}</p>
            </div>
            <div class="text-right">
              <div class="text-xs text-slate-500">概算見積（3製品の概算レンジ）</div>
              <div class="text-lg">${priceLine}</div>
            </div>
          </div>
          ${CTA}
          ${contact}
        </div>`;

      // ▼▼ インライン残響グラフ（3製品オーバーレイ） ▼▼
      $('#proposalSummary').insertAdjacentHTML('beforeend', `
        <div id="rtChartInlineWrap" class="mt-4 p-4 md:p-5 rounded-2xl border border-slate-200 dark:border-slate-700">
          <div class="text-base font-semibold mb-2">残響時間シミュレーション（標準枚数・3製品比較）</div>
          <div class="text-xs text-slate-500 mb-3" id="rtChartInlineSummary">
            目標：会議室の目安とする残響時間は <b>0.6秒</b> です（用途により自動補正）。
          </div>
          <div class="relative" style="height:320px">
            <canvas id="rtChartInline" aria-label="残響時間グラフ（3製品比較）" role="img"></canvas>
          </div>
          <div id="rtChartInlineDescription" class="mt-4 text-sm text-slate-700 dark:text-slate-200 space-y-2"></div>
        </div>
      `);
      try { renderRTChartInlineMulti(d, rt, allPanelSols); } catch(e){ console.warn(e); }

      const needTips = d.features.some(x=>['transom','shared_plenum','grille'].includes(x));
      if (needTips) {
        $('#proposalSummary').insertAdjacentHTML('beforeend', `
          <div class="mt-3 p-3 rounded-lg border border-amber-300 bg-amber-50 dark:bg-amber-900/20 text-amber-900 dark:text-amber-100">
            <div class="text-sm font-semibold mb-1">開口部からの音の回り込みに注意</div>
            <div class="text-xs">
              欄間・共有天井・換気開口は隣室への回り込み経路になりやすく、遮音対策（上部インフィル／ライニングダクト／隙間封止）が必要です。
              ${d.features.includes('transom')? '欄間オープンでも壁面が硬質だと室内が反響しやすくなります。<strong>吸音</strong>で響きを抑えると回り込み軽減に寄与する場合があります。':''}
            </div>
          </div>`);
      }
    }

    function renderEvidence(d,S,rt, recs=[], allPanelSols=null){
      const L = (rt.T500==null? {line1:'残響：—（ブース製品のため参考）', line2:`吸音必要度 ${(S.S_abs??'—')} / 遮音必要度 ${(S.S_isl??'—')}（0〜100）`, line3:'回り込みの要因：—', explainRT:'', explainLeak:''} : evidenceLines(d,S,rt));
      let card1_html = `
        <div class="p-4 rounded-xl bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700">
          <div class="text-sm text-slate-500 mb-1">① サマリ指標（0〜100）</div>
          <div class="grid grid-cols-1 gap-3">
            <div class="p-3 rounded-lg border border-slate-200 dark:border-slate-700">
              <div class="text-sm font-semibold">吸音必要度</div>
              <div class="text-2xl font-bold">${S.S_abs??'—'}</div>
              <div class="text-xs text-slate-500 mt-1">${S.S_abs==null?'ブースは製品仕様の影響が大きいため、数値は参考扱いです。':cardExplainAbs(S.S_abs)}</div>
            </div>
            <div class="p-3 rounded-lg border border-slate-200 dark:border-slate-700">
              <div class="text-sm font-semibold">遮音必要度</div>
              <div class="text-2xl font-bold">${S.S_isl??'—'}</div>
              <div class="text-xs text-slate-500 mt-1">${S.S_isl==null?'ブースの漏れ/遮音は製品依存のため、現場確認を推奨します。':cardExplainIsl(S.S_isl,d)}</div>
            </div>
          </div>
          <div class="text-xs text-slate-500 mt-2">${d.company||'（未入力）'}・${d.person||''}／${d.rooms}室・${d.area}m²/室</div>
        </div>`;

      let card2_html = `
        <div class="p-4 rounded-xl bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700">
          <div class="text-sm text-slate-500 mb-1">② 侵入・回り込み</div>
          <div class="text-sm">${L.line3}</div>
          <div class="text-xs mt-2">${L.explainLeak}</div>
        </div>`;

      // recsが1枚のときの価格レンジ（3製品）
      let card3_html = '';
      if (recs && recs.length === 1 && allPanelSols) {
        const plans = Object.values(allPanelSols).flatMap(p=>p.plans);
        const stdMin = Math.min(...plans.filter(p=>p.name==='標準').map(p=>p.subtotal));
        const proMax = Math.max(...plans.filter(p=>p.name==='強め').map(p=>p.subtotal));
        const r = recs[0];
        const priceHtml = `${yen(stdMin)}〜${yen(proMax)} <span class="text-xs text-slate-500">（概算・税抜）</span>`;
        card3_html = `
          <div class="p-4 rounded-2xl border border-slate-200 dark:border-slate-700 bg-white/50 dark:bg-slate-800/60">
            <div class="flex items-baseline justify-between mb-1">
              <div class="text-base font-semibold">解決カテゴリ：${r.label} <span class="badge">${r.priority}</span></div>
              <div class="text-xs text-slate-500">スコア：${Math.round(r.score)}</div>
            </div>
            <p class="text-sm text-slate-700 dark:text-slate-200">${r.reason}</p>
            <div class="mt-2"><span class="text-xs text-slate-500">概算見積：</span><span class="text-base font-semibold tabular-nums">${priceHtml}</span></div>
          </div>`;
      }
      $('#evidenceWrap').innerHTML = card1_html + card2_html + card3_html;
    }

    function renderRecommendations(recs, allPanelSols, primaryKey){
      if (recs && recs.length === 1) { $('#recommendWrap').innerHTML = ''; return; }
      const plans = Object.values(allPanelSols).flatMap(p=>p.plans);
      const stdMin = Math.min(...plans.filter(p=>p.name==='標準').map(p=>p.subtotal));
      const proMax = Math.max(...plans.filter(p=>p.name==='強め').map(p=>p.subtotal));
      $('#recommendWrap').innerHTML = recs.map(r=>{
        let priceHtml = `<span class="badge bg-white/60 dark:bg-slate-800/60">別途見積</span>`;
        if (r.key==='absorption' || r.key==='abs_plus_seal'){ priceHtml = `${yen(stdMin)}〜${yen(proMax)} <span class="text-xs text-slate-500">（概算・税抜）</span>`; }
        return `
          <div class="p-4 rounded-2xl border border-slate-200 dark:border-slate-700 bg-white/50 dark:bg-slate-800/60">
            <div class="flex items-baseline justify-between mb-1">
              <div class="text-base font-semibold">解決カテゴリ：${r.label} <span class="badge">${r.priority}</span></div>
              <div class="text-xs text-slate-500">スコア：${Math.round(r.score)}</div>
            </div>
            <p class="text-sm text-slate-700 dark:text-slate-200">${r.reason}</p>
            <div class="mt-2"><span class="text-xs text-slate-500">概算見積：</span><span class="text-base font-semibold tabular-nums">${priceHtml}</span></div>
          </div>`;
      }).join('');
    }

    function renderIwasemiDetailMulti(d, allPanelSols, primaryKey){
      const blocks = Object.values(allPanelSols).map(ps=>{
        const std=ps.plans.find(p=>p.name==='標準'); const pro=ps.plans.find(p=>p.name==='強め');
        const mk = (b)=> b.map(x=>`<div class="flex items-center justify-between text-sm"><span>${x.name} × <b>${x.qty}</b></span><span class="tabular-nums">${yen(x.price)}</span></div>`).join('');
        return `
          <div class="rounded-2xl border border-slate-200 dark:border-slate-700 p-4 md:p-5">
            <div class="text-lg font-semibold mb-1">${ps.product.name} の見積内容</div>
            <p class="text-sm text-slate-600 dark:text-slate-300 mb-3">数量・代表種類、工法（仮設/夜間施工を含む）、概算金額を表示します。</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="p-4 rounded-xl bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700">
                <div class="font-semibold mb-2">標準プラン</div>
                ${mk(std.bom)}
                <div class="mt-2 flex items-center justify-between pt-2 border-t border-slate-200 dark:border-slate-700">
                  <span class="text-sm">小計</span><span class="text-lg font-bold">${yen(std.subtotal)}</span>
                </div>
              </div>
              <div class="p-4 rounded-xl bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700">
                <div class="font-semibold mb-2">強めプラン</div>
                ${mk(pro.bom)}
                <div class="mt-2 flex items-center justify-between pt-2 border-t border-slate-200 dark:border-slate-700">
                  <span class="text-sm">小計</span><span class="text-lg font-bold">${yen(pro.subtotal)}</span>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');
      $('#iwasemiWrap').innerHTML = `
        <div class="p-4 md:p-5 rounded-2xl border border-slate-200 dark:border-slate-700">
          <div class="text-lg font-semibold mb-2">iwasemiの場合の見積内容（3製品）</div>
          <div class="grid grid-cols-1 gap-4">${blocks}</div>
          <p class="text-xs text-slate-500 mt-3">※ 概算（税抜）。仕上げ・物流・現場条件で変動します。<br>※ 「隙間封止（参考費用・別途手配）」はPxDT施工対象外です。必要に応じて内装業者等へご手配ください。</p>
        </div>`;
    }

    function renderNotes(primaryKey){
      const notes=[];
      if (primaryKey==='isolation') notes.push('遮音工事（欄間・共有天井のインフィル、扉更新、二重ガラス等）は別途社内見積が必要です。');
      if (primaryKey==='abs_plus_seal') notes.push('「隙間封止」はドア下・枠まわり・貫通部等の簡易遮音の参考費用です（別途手配）。吸音との併用で体感改善を早期化します。');
      $('#notesWrap').innerHTML = `
        <div class="p-4 rounded-2xl bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700">
          <div class="font-semibold mb-1">注意・前提</div>
          <ul class="list-disc pl-5 space-y-1 text-sm text-slate-600 dark:text-slate-300">
            <li>残響時間は簡易推定です（500/1000Hz平均）。形状・家具・在室人数で変動します。</li>
            ${notes.map(n=>`<li>${n}</li>`).join('')}
            <li>サウンドマスキング、AV機器、建築遮音は貴社内の管轄部署とご連携ください。</li>
          </ul>
        </div>`;
    }

    /* ===== 事例（既存＋追加） ===== */
    const CASES = [
      {company:'ヤンマーホールディングス株式会社',          place:'会議室', space:'会議室（密閉）',     problem:'音漏れ', effects:['集中力向上','音漏れの低減'], area:19,  rooms:1},
      {company:'文部科学省',                               place:'会議室', space:'会議室（密閉）',     problem:'反響',   effects:['会議の聞き取り','Web会議の聞き取り','話しやすさ'], area:9,   rooms:1},
      {company:'ノックス株式会社',                         place:'会議室', space:'会議室（密閉）',     problem:'反響',   effects:['会議の聞き取り','Web会議の聞き取り','話しやすさ'], area:18,  rooms:1},
      {company:'東京建物株式会社',                         place:'会議室', space:'会議室（密閉）',     problem:'反響',   effects:['会議の聞き取り','Web会議の聞き取り','話しやすさ'], area:8.4, rooms:1},
      {company:'トヨタコネクティッド株式会社',             place:'会議室', space:'会議室（密閉）',     problem:'反響',   effects:['会議の聞き取り','Web会議の聞き取り','話しやすさ'], area:9.2, rooms:2},
      {company:'株式会社アストン',                         place:'会議室', space:'会議室（密閉）',     problem:'反響',   effects:['会議の聞き取り','Web会議の聞き取り','話しやすさ'], area:16,  rooms:1},
      {company:'株式会社マルニコーポレーション',           place:'会議室', space:'会議室（密閉）',     problem:'音漏れ', effects:['集中力向上','音漏れの低減'],         area:12,  rooms:4},
      {company:'株式会社小野測器',                         place:'役員会議室', space:'会議室（密閉）', problem:'反響',   effects:['会議の聞き取り','Web会議の聞き取り','話しやすさ'], area:59.5, rooms:2},
      {company:'パナソニック エンターテインメント＆コミュニケーション株式会社', place:'会議室', space:'会議室（密閉）', problem:'反響', effects:['会議の聞き取り','Web会議の聞き取り','話しやすさ'], area:74.2, rooms:1},
      {company:'株式会社北國銀行',                         place:'会議室', space:'会議室（密閉）',     problem:'反響',   effects:['会議の聞き取り','Web会議の聞き取り','話しやすさ'], area:22,  rooms:3},
      {company:'国土交通省',                               place:'会議室', space:'会議室（欄間オープン）', problem:'音漏れ', effects:['集中力向上','音漏れの低減'],         area:18,  rooms:2},
      {company:'ニッセイ・ウェルス生命保険株式会社',         place:'役員会議室', space:'会議室（密閉）', problem:'反響',   effects:['会議の聞き取り','Web会議の聞き取り','話しやすさ'], area:40,  rooms:1},
      {company:'コインチェック株式会社',                   place:'会議室', space:'会議室（密閉）',     problem:'反響',   effects:['会議の聞き取り','Web会議の聞き取り','話しやすさ'], area:null, rooms:13},
      {company:'トヨタ自動車東日本株式会社',               place:'会議室', space:'会議室（密閉）',     problem:'反響',   effects:['会議の聞き取り','Web会議の聞き取り','話しやすさ'], area:null, rooms:4},
      {company:'Maison Comado 目黒スタジオ',               place:'スタジオ', space:'スタジオ',           problem:'反響',   effects:['話しやすさ'],                                 area:null, rooms:1},
    ];
    const CASE_IMG = {
      'ノックス': 'https://storage.googleapis.com/studio-cms-assets/projects/JpOLNkebaQ/s-2400x1588_v-frms_webp_3cbe404c-75d6-4e03-a62a-ccb5d4e1bf2a.jpg',
      '小野測器': 'https://storage.googleapis.com/studio-cms-assets/projects/JpOLNkebaQ/s-2388x1321_v-frms_webp_c232231e-3823-470b-9090-e72e25eb6e1c.png',
      'マルニ':   'https://storage.googleapis.com/studio-cms-assets/projects/JpOLNkebaQ/s-934x649_v-fs_webp_95193a5e-061a-4636-8c33-235b921e0e61.jpg',
      'アストン': 'https://storage.googleapis.com/studio-cms-assets/projects/JpOLNkebaQ/s-2400x1600_v-frms_webp_9ebd7a93-0b96-4f2e-a7af-45ebeb6a0738.jpg',
      '東京建物': 'https://storage.googleapis.com/studio-cms-assets/projects/JpOLNkebaQ/s-2400x1601_v-frms_webp_89d08d5f-9ad3-42aa-a86f-d5eda6b37341.jpg',
      'ヤンマー': 'https://storage.googleapis.com/studio-cms-assets/projects/JpOLNkebaQ/s-2400x1601_v-frms_webp_27fb2553-22a6-4a7f-be6e-d28fe418a633.jpg',
      'パナソニック': 'https://storage.googleapis.com/studio-cms-assets/projects/JpOLNkebaQ/s-2400x1600_v-frms_webp_00ebe96d-5f99-4eb6-b787-25acb33066b0.jpg',
      'トヨタコネク': 'https://storage.googleapis.com/studio-cms-assets/projects/JpOLNkebaQ/s-2400x1600_v-frms_webp_e0ce5f6f-f1d2-4ae4-ada9-bae2514f1fab.jpg',
      '文部科学省': 'https://storage.googleapis.com/studio-cms-assets/projects/JpOLNkebaQ/s-2400x1601_v-frms_webp_9fdc4207-ca78-475d-890e-5ca0e4d34d08.jpg',
      'ニッセイ・ウェルス': 'https://storage.googleapis.com/studio-cms-assets/projects/JpOLNkebaQ/s-2400x1601_v-frms_webp_f34ed0a6-e0aa-468b-80bf-c327b8764cdf.jpg',
      '国土交通省': 'https://storage.googleapis.com/studio-cms-assets/projects/JpOLNkebaQ/s-5464x8192_v-frms_webp_6b248fdc-adb9-4ff7-8bff-0dc90638c33f.jpg',
      '北國銀行': 'https://storage.googleapis.com/studio-cms-assets/projects/JpOLNkebaQ/s-2400x1601_v-frms_webp_595a7dc4-088c-4a60-b2f8-2ca3cdaadf83.jpg',
      'トヨタ自動車東日本': 'https://storage.googleapis.com/studio-cms-assets/projects/JpOLNkebaQ/s-6000x3376_v-frms_webp_a5df4af2-716a-4899-baf4-2584b996f190.jpg',
      'Maison Comado': 'https://storage.googleapis.com/studio-cms-assets/projects/JpOLNkebaQ/s-4032x3024_v-frms_webp_78f5a8f-2eba-49a6-8074-41ffab353fa2.jpg',
      'コインチェック': 'https://storage.googleapis.com/studio-design-asset-files/projects/JpOLNkebaQ/s-2400x621_v-frms_webp_7d402690-6c30-46e1-96ce-ae19f2480ef5_small.webp'
    };
    const CASE_URL = {
      'ノックス': 'https://iwasemi.com/posts/acoustic-solution-knox-demo-room',
      '小野測器': 'https://iwasemi.com/posts/onosokki-acousticpanel',
      'マルニ':   'https://iwasemi.com/posts/maruni-acousticpanel',
      'アストン': 'https://iwasemi.com/posts/aston-iwasemi',
      '東京建物': 'https://iwasemi.com/posts/tokyo-building-acoustic-solution',
      'ヤンマー': 'https://iwasemi.com/posts/yanmar-acousticpanel',
      'パナソニック': 'https://iwasemi.com/posts/panasonic-iwasemi',
      'トヨタコネク': 'https://iwasemi.com/posts/toyota-connected-acoustic-solution',
      '文部科学省': 'https://iwasemi.com/posts/mext-iwasemi-case-study',
      'ニッセイ・ウェルス': 'https://iwasemi.com/posts/nw-life-iwasemi',
      '国土交通省': 'https://iwasemi.com/posts/MLIT-iwasemi',
      '北國銀行': 'https://iwasemi.com/posts/HokkokuBank',
      'トヨタ自動車東日本': 'https://iwasemi.com/posts/toyota-ej-iwasemi',
      'Maison Comado': 'https://iwasemi.com/posts/cWx2W1kL',
      'コインチェック': 'https://iwasemi.com/posts/coincheck-iwasemi',
      'AlphaTheta': 'https://iwasemi.com/posts/TkRNjiG4',
      'カラーキネティクス・ジャパン': 'https://iwasemi.com/posts/KsuWWevd',
      'マキナレコード': 'https://iwasemi.com/posts/78cWIDRJ',
      'Krafton': 'https://iwasemi.com/posts/Wotida0r',
      'Agit Global': 'https://iwasemi.com/posts/H29EGkQz',
      '直島建設': 'https://iwasemi.com/posts/0kWh2f4M',
      'British American Tobacco Taiwan': 'https://iwasemi.com/posts/bat-iwasemi',
      'One&Co': 'https://iwasemi.com/posts/q0fCIy0N',
      'クレディセゾン': 'https://iwasemi.com/posts/NU9mx_QY'
    };
    const CASES_LINKONLY = [
      {company:'AlphaTheta株式会社'},
      {company:'カラーキネティクス・ジャパン株式会社'},
      {company:'株式会社マキナレコード'},
      {company:'Krafton Inc'},
      {company:'Agit Global, Inc.'},
      {company:'直島建設有限会社'},
      {company:'British American Tobacco Taiwan'},
      {company:'One&Co'},
      {company:'株式会社クレディセゾン'}
    ];

    function getCaseImg(name){ const k=Object.keys(CASE_IMG).find(key=> name.includes(key)); return k?CASE_IMG[k]:''; }
    function getCaseUrl(name){ const k=Object.keys(CASE_URL).find(key=> name.includes(key)); return k?CASE_URL[k]:''; }
    function mapUserPlace(d){
      if (d.spaceType?.startsWith('booth')) return 'ブース';
      if (d.spaceType==='studio') return 'スタジオ';
      if (d.uses?.includes('exec')) return '役員会議室';
      return '会議室';
    }
    function mapUserSpace(d){
      if (d.spaceType==='meeting_closed')   return '会議室（密閉）';
      if (d.spaceType==='meeting_transom')  return '会議室（欄間オープン）';
      if (d.spaceType?.startsWith('booth')) return 'ブース';
      if (d.spaceType==='studio')           return 'スタジオ';
      return '会議室（密閉）';
    }
    function inferProblems(d, S){
      const probs = new Set();
      if (S?.S_abs==null || S?.S_abs>=12) probs.add('反響');
      const islTrig = (S?.S_isl!=null && S.S_isl>=30) || d.sources?.includes('invasion_ext') ||
                      d.features?.some(x=> ['transom','shared_plenum','grille','gap_door_bottom','gap_frame','gap_penetration','gap_duct'].includes(x));
      if (islTrig) probs.add('音漏れ');
      return Array.from(probs);
    }
    function mapEffectsJ(d){
      const m = { clarity_meeting:'会議の聞き取り', clarity_web:'Web会議の聞き取り', speaking:'話しやすさ', focus:'集中力向上', leakage:'音漏れの低減' };
      return (d.effects||[]).map(x=> m[x]).filter(Boolean);
    }
    function caseScore(d, S, rt, c){
      let score=0;
      const uSpace=mapUserSpace(d);
      if (c.space && uSpace===c.space) score+=35; else if (c.space && uSpace.startsWith('会議室') && c.space.startsWith('会議室')) score+=25;
      const uPlace=mapUserPlace(d);
      if (c.place && uPlace===c.place) score+=15; else if (c.place && uPlace.includes('会議室') && c.place.includes('会議室')) score+=10;
      const uProbs=inferProblems(d,S);
      if (c.problem && uProbs.includes(c.problem)) score+=30;
      else if (c.problem==='反響' && (S?.S_abs==null || S.S_abs>=12)) score+=18;
      else if (c.problem==='音漏れ' && (S?.S_isl==null || S.S_isl>=30)) score+=18;
      const want=new Set(mapEffectsJ(d)), have=new Set(c.effects||[]); const inter=[...have].filter(x=>want.has(x)).length; score+=Math.min(15, inter*7.5);
      if (typeof c.area==='number' && d.area){ const closeness=Math.max(0,1-Math.abs(c.area-d.area)/Math.max(5,d.area)); score+=5*closeness; }
      if (typeof c.rooms==='number' && d.rooms){ const closeness=Math.max(0,1-Math.abs(c.rooms-d.rooms)/Math.max(1,d.rooms)); score+=5*closeness; }
      if ((!c.place && !c.space) || !c.problem){ score += getCaseUrl(c.company)?10:0; }
      if (!getCaseUrl(c.company)) score*=0.95;
      return score;
    }
    function selectCaseStudies(d,S,rt){
      const ALL = [
        ...CASES,
        ...CASES_LINKONLY.map(x=>({company:x.company, place:null, space:null, problem:null, effects:[], area:null, rooms:null}))
      ];
      return ALL
        .map(c=>({...c,img:getCaseImg(c.company),url:getCaseUrl(c.company),_score:caseScore(d,S,rt,c)}))
        .filter(c=>c.url)
        .sort((a,b)=>b._score-a._score)
        .slice(0,3);
    }
    function renderCaseStudies(cases){
      const wrap = $('#caseWrap'); if (!wrap) return;
      if (!cases || !cases.length){ wrap.innerHTML=''; return; }
      wrap.innerHTML = `
        <div class="p-4 md:p-5 rounded-2xl border border-slate-200 dark:border-slate-700">
          <div class="text-base font-semibold mb-3">近い導入事例</div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            ${cases.map(c=>`
              <a class="block rounded-xl overflow-hidden bg-slate-900/5 dark:bg-white/5 border border-slate-200/70 dark:border-slate-700 hover:opacity-90"
                 href="${c.url||'#'}" target="_blank" rel="noopener">
                <div class="aspect-[4/3] bg-slate-200/40 dark:bg-slate-700/40">
                  <img src="${c.img}" alt="${c.company}" style="width:100%;height:100%;object-fit:cover"
                       onerror="this.style.display='none';this.parentElement.style.background='linear-gradient(135deg,#0ea5e9,#10b981)';">
                </div>
                <div class="p-3">
                  <div class="text-sm font-semibold truncate">${c.company}</div>
                  <div class="mt-1 flex flex-wrap gap-1 text-[11px] text-slate-500">
                    ${c.place?`<span class="px-1.5 py-0.5 rounded bg-slate-200/60 dark:bg-slate-700/60">${c.place}</span>`:''}
                    ${c.space?`<span class="px-1.5 py-0.5 rounded bg-slate-200/60 dark:bg-slate-700/60">${c.space}</span>`:''}
                    ${c.problem?`<span class="px-1.5 py-0.5 rounded bg-slate-200/60 dark:bg-slate-700/60">${c.problem}</span>`:''}
                  </div>
                  <div class="text-[11px] text-slate-500 mt-1">${(c.area??'—')}m² / ${c.rooms??'—'}室</div>
                </div>
              </a>
            `).join('')}
          </div>
        </div>`;
    }

    /* ========== Googleフォーム送信 ========== */
    const GF_FORM_ID='1FAIpQLSf8Eo_j14pXA3mTRSt5tN_gQ0Py46cV-8Rd1ZBW7Nt9cltIpQ';
    const GF_ENDPOINT=`https://docs.google.com/forms/d/e/${GF_FORM_ID}/formResponse`;
    const ENTRY_MAP = {
      company:'entry.633735891',
      person:'entry.1897466872',
      email:'entry.520438276',
      pref:'entry.1016772262',

      project:'entry.1643209832',
      category:'entry.1456767678',
      spaceType:'entry.875012016',
      uses:'entry.829570765',
      sources:'entry.1840420677',

      area:'entry.1193986863',
      rooms:'entry.1894381184',
      ceilHeight:'entry.237126416',

      wall1:'entry.713604363',
      wall2:'entry.1601335444',
      wall3:'entry.803869896',
      wall4:'entry.784934428',

      floor:'entry.402764184',
      ceiling:'entry.665830996',
      door:'entry.67943677',
      doorSeal:'entry.901692185',
      glazing:'entry.1003016767',
      features:'entry.685782864',

      industry:'entry.863972',
      size:'entry.743322677',
      timeline:'entry.335161338',
      complaint:'entry.1013219285',

      effects:'entry.127489878',
      zeroLeak:'entry.363506085',
      selfScore:'entry.1025555385',
      S_abs:'entry.2144586639',
      S_isl:'entry.23030069',
      primaryKey:'entry.902891300',
      topLabel:'entry.892698191',
      topReason:'entry.447335823',
      panels_std:'entry.1375581996',
      panels_pro:'entry.267227546',
      price_std:'entry.1883756001',
      price_pro:'entry.382111843',
      raw_json:'entry.1555376589',

      agentCompany:'entry.1294566503',
      agentPerson:'entry.2017082841',
      agentEmail:'entry.1181916971',
    };
    function buildGoogleFormPayload(diag){
      const d=diag.input, S=diag.scores, recs=diag.recommendations, top=recs[0]||{key:'measure',label:'計測／トライアル',reason:'',score:0};

      // フォームの互換性のため RC-α の標準/強めを代表値として送る
      const pRc = diag.panels.rc;
      return {
        company:d.company, person:d.person, email:d.email, pref:d.pref, project:d.project, category:d.category, spaceType:d.spaceType,
        uses:d.uses.join(','), sources:d.sources.join(','), area:d.area, rooms:d.rooms, ceilHeight:d.ceilHeight,
        wall1:d.walls[0], wall2:d.walls[1], wall3:d.walls[2], wall4:d.walls[3], floor:d.floor, ceiling:d.ceiling, door:d.door, doorSeal:d.doorSeal, glazing:d.glazing,
        features:d.features.join(','),

        industry:d.industry, size:d.size, timeline:d.timeline, complaint:d.complaint,
        effects:d.effects.join(','), zeroLeak:d.zeroLeak?'yes':'no', selfScore:d.selfScore,

        S_abs:S.S_abs??'NA', S_isl:S.S_isl??'NA', primaryKey:top.key, topLabel:top.label, topReason:top.reason,
        panels_std: pRc?.plans.find(p=>p.name==='標準')?.panels||0, panels_pro: pRc?.plans.find(p=>p.name==='強め')?.panels||0,
        price_std: pRc?.plans.find(p=>p.name==='標準')?.subtotal||0, price_pro: pRc?.plans.find(p=>p.name==='強め')?.subtotal||0,
        raw_json: JSON.stringify(diag),

        agentCompany:d.agentCompany, agentPerson:d.agentPerson, agentEmail:d.agentEmail,
      };
    }
    async function postToGoogleForm(payload){
      const norm=v=>Array.isArray(v)?v.join(','): (typeof v==='boolean'?(v?'yes':'no'):(v??''));
      const params=new URLSearchParams(); for(const [k,eid] of Object.entries(ENTRY_MAP)){ if(k in payload) params.append(eid, norm(payload[k])); }
      try{
        await fetch(GF_ENDPOINT,{method:'POST',mode:'no-cors',headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'}, body:params.toString()});
        return {ok:true,mode:'no-cors'};
      }catch(e){
        try{ const blob=new Blob([params.toString()],{type:'application/x-www-form-urlencoded;charset=UTF-8'}); if(navigator.sendBeacon(GF_ENDPOINT,blob)) return {ok:true,mode:'beacon'}; }catch(_){}
        return {ok:false};
      }
    }

    /* ========== グラフ描画 ========== */
    function commonChartOptions(targetLine){
      return {
        responsive:true, maintainAspectRatio:false,
        scales: {
          x: {
            type:'category',
            title:{display:true,text:'周波数 (Hz)'},
            ticks:{
              callback: (value, idx)=> {
                const label = FREQ_LABELS[idx];
                return ['500Hz','1000Hz','2000Hz','4000Hz','8000Hz'].includes(label) ? label : '';
              }
            }
          },
          y: {
            title:{display:true,text:'残響時間 (s)'},
            ticks:{ callback:(v)=>fmt2(v)+'s' },
            min:0
          }
        },
        plugins:{
          legend:{labels:{}},
          tooltip:{callbacks:{label:(ctx)=>`${ctx.dataset.label}: ${ctx.formattedValue} s`}}
        }
      };
    }

    function convBandPlugin(){
      return {
        id:'conv-band',
        afterDraw(chart){
          const {ctx, chartArea, scales} = chart;
          const x1 = scales.x.getPixelForValue('500Hz');
          const x2 = scales.x.getPixelForValue('1000Hz');
          if (Number.isFinite(x1) && Number.isFinite(x2)){
            ctx.save();
            ctx.fillStyle='rgba(234,88,12,0.12)';
            ctx.fillRect(x1, chartArea.top, (x2-x1), chartArea.bottom-chartArea.top);
            ctx.fillStyle='rgba(234,88,12,0.9)';
            ctx.font='12px "Noto Sans JP", sans-serif';
            ctx.textAlign='center';
            ctx.fillText('人の会話音の中心周波数帯域 500〜1000Hz', (x1+x2)/2, chartArea.top+18);
            ctx.restore();
          }
        }
      };
    }

    function calcTAfterForProduct(rt_before, panelsStd, product){
      const a = alphaVec(product);
      const added_Aeq = a.map((alpha_panel,i)=> alpha_panel * product.panelArea * panelsStd);
      const T_after = (rt_before.Aeq_values||[]).map((Aeq_before, i) => {
        const Aeq_total = Aeq_before + (added_Aeq[i]||0);
        return 0.161 * rt_before.V / Math.max(0.001, Aeq_total);
      });
      return { T_after, added_Aeq };
    }

    function renderRTChartInlineMulti(d, rt_before, allPanelSols){
      try{
        const ctx = $('#rtChartInline').getContext('2d');

        // 標準枚数（各製品）
        const stdPanels = {
          rc: allPanelSols.rc.plans.find(p=>p.name==='標準')?.panels || 0,
          sq: allPanelSols.sq.plans.find(p=>p.name==='標準')?.panels || 0,
          hx: allPanelSols.hx.plans.find(p=>p.name==='標準')?.panels || 0
        };

        const rcAfter = calcTAfterForProduct(rt_before, stdPanels.rc, PRODUCTS.rc);
        const sqAfter = calcTAfterForProduct(rt_before, stdPanels.sq, PRODUCTS.sq);
        const hxAfter = calcTAfterForProduct(rt_before, stdPanels.hx, PRODUCTS.hx);

        const T_target_line = Array(FREQS.length).fill(allPanelSols.rc.Ttgt||0.6);

        if (window.myRtChartInline) { try{ window.myRtChartInline.destroy(); }catch(e){} }
        window.myRtChartInline = new Chart(ctx, {
          type:'line',
          data:{
            labels:FREQ_LABELS,
            datasets:[
              {label: '現状（推定）', data:(rt_before.T_values||[]).map(v=>Number(fmt2(v))), fill:false, tension:0.1},
              {label: 'RC-α（標準）', data:rcAfter.T_after.map(v=>Number(fmt2(v))), fill:false, tension:0.1, borderWidth:2},
              {label: 'SQ-α（標準）', data:sqAfter.T_after.map(v=>Number(fmt2(v))), fill:false, tension:0.1, borderWidth:2},
              {label: 'HX-α（標準）', data:hxAfter.T_after.map(v=>Number(fmt2(v))), fill:false, tension:0.1, borderWidth:2},
              {label: '目標残響時間', data:T_target_line.map(v=>Number(fmt2(v))), fill:false, borderDash:[5,5], pointRadius:0, borderWidth:1.5}
            ]
          },
          options: commonChartOptions(allPanelSols.rc.Ttgt||0.6),
          plugins:[convBandPlugin()]
        });

        // サマリテキスト
        const tgt = allPanelSols.rc.Ttgt||0.6;
        $('#rtChartInlineSummary').innerHTML =
          `目標：会議室の目安とする残響時間は <b>0.6秒</b> です（今回の目標＝<b>${fmt2(tgt)}秒</b>）。`;

        // 500/1000Hz 平均（前後＆減少率）
        const T_500_before = (rt_before.T_values && rt_before.T_values.length > 1) ? rt_before.T_values[1] : 0;
        const T_1000_before = (rt_before.T_values && rt_before.T_values.length > 2) ? rt_before.T_values[2] : 0;
        const T_avg_before = (T_500_before + T_1000_before) / 2;

        function avg500_1000(arr){
          const v500 = (arr && arr.length>1)?arr[1]:0;
          const v1000= (arr && arr.length>2)?arr[2]:0;
          return (v500+v1000)/2;
        }
        function redPct(before, after){ return before>0.001 ? ((before-after)/before)*100 : 0; }

        const avgRC = avg500_1000(rcAfter.T_after);
        const avgSQ = avg500_1000(sqAfter.T_after);
        const avgHX = avg500_1000(hxAfter.T_after);

        const rRC = Math.round(redPct(T_avg_before, avgRC));
        const rSQ = Math.round(redPct(T_avg_before, avgSQ));
        const rHX = Math.round(redPct(T_avg_before, avgHX));

        const descWrap = $('#rtChartInlineDescription');
        if (descWrap) {
          descWrap.innerHTML = `
            <div class="font-semibold text-base mb-1">【シミュレーション結果】</div>
            <ul class="list-disc pl-5 space-y-2">
              <li>通常会議室の500～1000Hzにおける平均残響時間は<b class="font-bold">約0.6秒</b>程度となります。</li>
              <li>今回の環境下では、人の声の帯域にあたる500～1000Hzにおける平均残響時間が
                <b class="font-bold text-red-600 dark:text-red-400">${fmt2(T_avg_before)}秒</b> と、平均を上回る数値でした。
              </li>
              <li>${PRODUCTS.rc.name} を <b class="font-bold text-red-600 dark:text-red-400">${stdPanels.rc}枚</b> 設置した場合、
                同帯域の平均残響時間は <b class="font-bold text-red-600 dark:text-red-400">${fmt2(avgRC)}秒</b> まで低下（減少率
                <b class="font-bold text-red-600 dark:text-red-400">${rRC}%</b>）の予測です。</li>
              <li>${PRODUCTS.sq.name} を <b class="font-bold text-red-600 dark:text-red-400">${stdPanels.sq}枚</b> 設置した場合、
                同帯域の平均残響時間は <b class="font-bold text-red-600 dark:text-red-400">${fmt2(avgSQ)}秒</b> まで低下（減少率
                <b class="font-bold text-red-600 dark:text-red-400">${rSQ}%</b>）の予測です。</li>
              <li>${PRODUCTS.hx.name} を <b class="font-bold text-red-600 dark:text-red-400">${stdPanels.hx}枚</b> 設置した場合、
                同帯域の平均残響時間は <b class="font-bold text-red-600 dark:text-red-400">${fmt2(avgHX)}秒</b> まで低下（減少率
                <b class="font-bold text-red-600 dark:text-red-400">${rHX}%</b>）の予測です。</li>
            </ul>
          `;
        }
      }catch(e){
        console.warn('inline chart error', e);
      }
    }

    /* ========== Diagnose main ========== */
    async function diagnose(){
      if(!window.__autoPreview){
        if(!validateRequiredFields()){ clearResult(); return; }
      }

      const d=collect();

      // 大容積ガード
      const V_LIMIT=250; const H=heightFromKey(d.ceilHeight); const V=Math.max(0.1,d.area)*H;
      if (V>V_LIMIT){
        clearResult();
        $('#proposalSummary').innerHTML=`
          <div class="p-4 rounded-xl border border-amber-300 bg-amber-50 dark:bg-amber-900/20">
            <div class="font-semibold">このツールの対象外です（大容積）</div>
            <p class="text-sm mt-1">ホール等の大空間は容積連動の目標残響が必要です。<br>測定・設計検討が前提のため PxDT へ直接ご相談ください。</p>
          </div>`;
        window.__diagResult={input:d, note:'volume_out_of_scope', V};
        window.location.hash='#result';
        return;
      }

      // TELECUBE
      if (d.spaceType==='booth_tel'){
        const recs=[{key:'absorption',label:'吸音（ブース内面）',priority:'高',score:50,reason:'ブース内で残響（音の響き）が強く声がこもりやすいため、ガラスや金属面に小型吸音パネルを分散配置することが効果的です。'}];
        const dummyRT={T500:null,T1000:null,Aeq500:null,Aeq1000:null,V:V,A:d.area,H:H, Aeq_values:[], T_values:[]};
        const S={S_abs:null,S_isl:null}; const primaryKey=recs[0].key;

        // 3製品のパネル算出（ブースでも見積用に作る）
        const allPanelSols = buildAllPanelSolutions(d, primaryKey, dummyRT);

        clearResult();
        renderProposalSummary(d, recs, S, dummyRT, allPanelSols);
        renderEvidence(d, S, dummyRT, recs, allPanelSols);
        renderRecommendations(recs, allPanelSols, primaryKey);
        renderIwasemiDetailMulti(d, allPanelSols, primaryKey);
        renderNotes(primaryKey);
        renderTelecubeGallery();

        const diag={input:d,scores:S,rt:dummyRT,recommendations:recs,panels:allPanelSols};
        window.__diagResult=diag;
        if(!window.__autoPreview){ const payload=buildGoogleFormPayload(diag); const res=await postToGoogleForm(payload); toast(res?.ok?'診断に成功しました':'診断に失敗しました', !!res?.ok); }
        window.location.hash='#result';
        return;
      }

      // 通常ルート
      const rt=calcRT(d); const S={S_abs:scoreAbs(d,rt), S_isl:scoreIsl(d,rt)};
      const recs=recommend(d,S,rt); const primaryKey=recs[0]?.key||'absorption';

      const allPanelSols = buildAllPanelSolutions(d, primaryKey, rt);

      clearResult();
      renderProposalSummary(d, recs, S, rt, allPanelSols);
      renderEvidence(d, S, rt, recs, allPanelSols);
      renderRecommendations(recs, allPanelSols, primaryKey);
      if (['absorption','abs_plus_seal'].includes(primaryKey)) renderIwasemiDetailMulti(d, allPanelSols, primaryKey);
      renderNotes(primaryKey);

      // 事例
      const matchedCases = selectCaseStudies(d, S, rt);
      renderCaseStudies(matchedCases);

      // 下部詳細グラフは非表示のまま
      const diag={input:d,scores:S,rt,recommendations:recs,panels:allPanelSols};
      window.__diagResult=diag;

      const needsTip=d.features.some(x=>['transom','shared_plenum','grille'].includes(x));
      if (needsTip && !window.__tipShown){ window.__tipShown=true; showTips({transom:d.features.includes('transom')}); }

      if(!window.__autoPreview){ const payload=buildGoogleFormPayload(diag); const res=await postToGoogleForm(payload); toast(res?.ok?'診断に成功しました':'診断に失敗しました', !!res?.ok); }
      window.location.hash='#result';
    }

    // ===== TELECUBE 参考事例 =====
    const TELECUBE_PHOTOS = [
      {title:'Cタイプ／1人用（片面ガラス）', sheets:'RC-α21枚', id:'1Ep_TSHn8RYXW1qHbiuxyAbuf6hdIL0Vk'},
      {title:'Cタイプ／4人用（片面ガラス）', sheets:'RC-α42枚', id:'1SASFmd2OW48eis-z6AsaO6l2vwJghsmV'},
      {title:'Cタイプ／4人用（両面ガラス）', sheets:'RC-α86枚', id:'1xBpMHpHT6IGGvdhxeTmC0dvoHnyNZ64F'},
      {title:'Cタイプ／多人用（片面ガラス）', sheets:'RC-α67枚', id:'1-kcfy7ogmZqSAsiJTKNwQk07a2QmNWsN'}
    ];
    function gdriveThumb(id, w=1600){ return `https://drive.google.com/thumbnail?id=${id}&sz=w${w}`; }
    function renderTelecubeGallery(){
      const wrap = $('#telecubeWrap'); if(!wrap) return;
      wrap.innerHTML = `
        <div class="p-4 md:p-5 rounded-2xl border border-slate-200 dark:border-slate-700">
          <div class="text-base font-semibold mb-3">TELECUBE 参考事例</div>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            ${TELECUBE_PHOTOS.map(p=>`
              <div class="rounded-xl overflow-hidden bg-slate-900/5 dark:bg-white/5 border border-slate-200/70 dark:border-slate-700">
                <img class="telecube-img" src="${gdriveThumb(p.id)}" alt="${p.title}">
                <div class="p-3">
                  <div class="text-sm font-semibold">${p.title}</div>
                  <div class="text-xs text-slate-500 mt-1">${p.sheets}</div>
                </div>
              </div>
            `).join('')}
          </div>
        </div>`;
    }

    // ===== Compact Multi-Select enhancer =====
    function enhanceMultiSelect(sel){
      if(!(sel instanceof HTMLSelectElement) || !sel.multiple) return;

      const wrap = document.createElement('div'); wrap.className='ms-wrap';
      const btn  = document.createElement('button'); btn.type='button'; btn.className='ms-btn';
      const label= document.createElement('div'); label.className='flex flex-wrap gap-1 items-center min-h-[1.75rem]';
      const caret= document.createElement('span'); caret.className='ms-caret'; caret.textContent='▾';
      btn.append(label, caret);

      const menu = document.createElement('div'); menu.className='ms-menu';
      Array.from(sel.options).forEach((opt, idx)=>{
        const item=document.createElement('button'); item.type='button'; item.className='ms-item';
        const check=document.createElement('span'); check.textContent='✓'; check.style.visibility= opt.selected?'visible':'hidden';
        const text=document.createElement('span'); text.textContent=opt.textContent;
        item.append(check, text);
        const sync = ()=>{ check.style.visibility = opt.selected?'visible':'hidden'; renderChips(); };
        item.addEventListener('click', (e)=>{ e.preventDefault(); opt.selected=!opt.selected; sel.dispatchEvent(new Event('input', {bubbles:true})); sel.dispatchEvent(new Event('change', {bubbles:true})); sync(); });
        menu.appendChild(item);
      });

      function renderChips(){
        label.innerHTML='';
        const selected = Array.from(sel.selectedOptions);
        if(!selected.length){ const ph=document.createElement('span'); ph.className='text-slate-500 text-sm'; ph.textContent='選択してください'; label.appendChild(ph); return; }
        selected.forEach(o=>{ const chip=document.createElement('span'); chip.className='ms-chip'; chip.textContent=o.textContent; label.appendChild(chip); });
      }
      renderChips();

      // mount
      sel.classList.add('hidden');
      sel.parentNode.insertBefore(wrap, sel);
      wrap.append(btn, menu, sel);

      // interactions
      btn.addEventListener('click', ()=>{ menu.style.display = (menu.style.display==='block'?'none':'block'); });
      document.addEventListener('click', (e)=>{ if(!wrap.contains(e.target)) menu.style.display='none'; });
      btn.addEventListener('keydown', e=>{ if(e.key==='Escape') menu.style.display='none'; });

      sel.addEventListener('change', renderChips);
    }

    function enhanceAllMultiSelects(){
      $$('select[multiple].ms-native', formEl).forEach(enhanceMultiSelect);
    }

    // Events
    $('#diagnoseBtn').addEventListener('click', async()=>{ window.__autoPreview=false; await diagnose(); });
    $('#resetBtn').addEventListener('click', ()=>{
      formEl.reset(); updateProgress(); clearResult(); $('#effectsError')?.classList.add('hidden');
      $$('input[required],select[required]').forEach(el=>setInvalid(el,false));
      $$('select[multiple].ms-native').forEach(sel=>sel.dispatchEvent(new Event('change')));
    });
    $('#downloadJson').addEventListener('click', ()=>{
      const payload=window.__diagResult||{note:'先に「診断する」を押してください。'};
      const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
      const url=URL.createObjectURL(blob); const a=document.createElement('a');
      a.href=url; a.download=`iwasemi-diagnosis-${Date.now()}.json`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });
    $('#printBtn').addEventListener('click', ()=>window.print());

    // Auto preview（送信しない）
    window.addEventListener('DOMContentLoaded', async()=>{
      try{
        enhanceAllMultiSelects();
        window.__autoPreview=true;
        await diagnose();
      }catch(e){}
    });
  </script>
</body>
</html>
